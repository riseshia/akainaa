<!DOCTYPE html>

<!-- This coverage report is generated from isucon 13 -->
<!-- Ref: https://github.com/isucon/isucon13/blob/9ab011eaade23464efc766397690067d761cf75e/webapp/ruby/ -->

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/a11y-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/ruby.min.js"></script>
    <style>
      .sidebar {
        background-color: #eee;
      }

      .pure-menu-heading {
        font-weight: bold;
      }

      .line {
        line-height: 20px;
      }

      .executed-count, .lineno {
        text-align: right;
      }

      p {
        padding: 0 5 0 5;
        margin: 0px;
      }

      pre.code {
        margin: 0px;
        background: transparent;
      }

      a.filepath {
        text-wrap: balance;
        word-break: break-all;
        color: #000;
      }
      a.filepath.current {
        font-weight: bold;
      }

      div.count-p90 {
        background-color: #ff392e;
      }
      div.count-p90:hover {
        background-color: #fedcda;
      }
      div.count-p80 {
        background-color: #ff5047;
      }
      div.count-p80:hover {
        background-color: #fedcda;
      }
      div.count-p70 {
        background-color: #ff675f;
      }
      div.count-p70:hover {
        background-color: #fedcda;
      }
      div.count-p60 {
        background-color: #ff7f78;
      }
      div.count-p50 {
        background-color: #ff9690;
      }
      div.count-p40 {
        background-color: #ffada9;
      }
      div.count-p30 {
        background-color: #fec4c1;
      }
      div.count-p20 {
        background-color: #fedcda;
      }
      div.count-p10, div.count-p0 {
        background-color: #ffffff;
      }
      .pure-menu-item > a.count-p90 {
        background-color: #ff392e;
      }
      .pure-menu-item > a.count-p80 {
        background-color: #ff5047;
      }
      .pure-menu-item > a.count-p70 {
        background-color: #ff675f;
      }
      .pure-menu-item > a.count-p60 {
        background-color: #ff7f78;
      }
      .pure-menu-item > a.count-p50 {
        background-color: #ff9690;
      }
      .pure-menu-item > a.count-p40 {
        background-color: #ffada9;
      }
      .pure-menu-item > a.count-p30 {
        background-color: #ffffff;
      }
      .pure-menu-item > a.count-p20 {
        background-color: #ffffff;
      }
      .pure-menu-item > a.count-p10 {
        background-color: #ffffff;
      }
      .pure-menu-item > a.count-p0 {
        background-color: #ffffff;
      }
    </style>
  </head>
  <body>
    <div id="layout" class="pure-g">
      <div class="sidebar pure-u-1-4">
        <div>
  <div class="pure-menu">
    <span class="pure-menu-heading">赤いなぁ</span>
    <ul class="pure-menu-list">
      <li class="pure-menu-item">
        <a href="https://pipe.t.isucon.pw/akainaa/reset" class="pure-button pure-button-primary">Reset</a>
      </li>
      <li class="pure-menu-heading">Files</li>
      <li class="pure-menu-item">
<a href="https://pipe.t.isucon.pw/akainaa?path=app.rb" class="pure-menu-link filepath current count-p90" "="">(337314) app.rb</a>
</li>

    </ul>
  </div>
</div>

      </div>
      <div class="content pure-u-3-4">
        <div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"><span class="hljs-comment"># frozen_string_literal: true</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>2:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>3:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"><span class="hljs-keyword">require</span> <span class="hljs-string">'base64'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>4:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"><span class="hljs-keyword">require</span> <span class="hljs-string">'bcrypt'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>5:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"><span class="hljs-keyword">require</span> <span class="hljs-string">'digest'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>6:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"><span class="hljs-keyword">require</span> <span class="hljs-string">'mysql2'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>7:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"><span class="hljs-keyword">require</span> <span class="hljs-string">'mysql2-cs-bind'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>8:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"><span class="hljs-keyword">require</span> <span class="hljs-string">'open3'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>9:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"><span class="hljs-keyword">require</span> <span class="hljs-string">'securerandom'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>10:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"><span class="hljs-keyword">require</span> <span class="hljs-string">'sinatra/base'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>11:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"><span class="hljs-keyword">require</span> <span class="hljs-string">'sinatra/json'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>12:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>13:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"><span class="hljs-keyword">module</span> <span class="hljs-title class_">Isupipe</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>14:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">  <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> &lt; <span class="hljs-title class_ inherited__">Sinatra::Base</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>15:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    enable <span class="hljs-symbol">:logging</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>16:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    set <span class="hljs-symbol">:show_exceptions</span>, <span class="hljs-symbol">:after_handler</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>17:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    set <span class="hljs-symbol">:sessions</span>, <span class="hljs-symbol">domain:</span> <span class="hljs-string">'t.isucon.pw'</span>, <span class="hljs-symbol">path:</span> <span class="hljs-string">'/'</span>, <span class="hljs-symbol">expire_after:</span> <span class="hljs-number">1000</span>*<span class="hljs-number">60</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>18:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    set <span class="hljs-symbol">:session_secret</span>, <span class="hljs-variable constant_">ENV</span>.fetch(<span class="hljs-string">'ISUCON13_SESSION_SECRETKEY'</span>, <span class="hljs-string">'isucon13_session_cookiestore_defaultsecret'</span>).unpack(<span class="hljs-string">'H*'</span>)[<span class="hljs-number">0</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>19:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>20:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-variable constant_">POWERDNS_SUBDOMAIN_ADDRESS</span> = <span class="hljs-variable constant_">ENV</span>.fetch(<span class="hljs-string">'ISUCON13_POWERDNS_SUBDOMAIN_ADDRESS'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>21:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>22:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span> = <span class="hljs-string">'SESSIONID'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>23:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-variable constant_">DEFAULT_SESSION_EXPIRES_KEY</span> = <span class="hljs-string">'EXPIRES'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>24:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-variable constant_">DEFAULT_USER_ID_KEY</span> = <span class="hljs-string">'USERID'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>25:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-variable constant_">DEFAULT_USERNAME_KEY</span> = <span class="hljs-string">'USERNAME'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>26:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>27:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpError</span> &lt; <span class="hljs-title class_ inherited__">StandardError</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>28:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-built_in">attr_reader</span> <span class="hljs-symbol">:code</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>29:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>30:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">def</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params">code, message = <span class="hljs-literal">nil</span></span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>31:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-variable language_">super</span>(message |<span class="hljs-params"></span>| <span class="hljs-string">"HTTP error <span class="hljs-subst">#{code}</span>"</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>32:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-variable">@code</span> = code
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>33:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>34:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>35:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>36:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    error <span class="hljs-title class_">HttpError</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>37:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      e = env[<span class="hljs-string">'sinatra.error'</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>38:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      status e.code
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>39:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(<span class="hljs-symbol">error:</span> e.message)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>40:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>41:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>42:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    helpers <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>43:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">def</span> <span class="hljs-title function_">db_conn</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p70">
  <div class="executed-count pure-u-2-24">
    <p>11450</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>44:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-title class_">Thread</span>.current[<span class="hljs-symbol">:db_conn</span>] |<span class="hljs-params"></span>|= connect_db
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>45:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>46:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>47:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_db</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>21</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>48:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-title class_">Mysql2::Client</span>.new(
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>49:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">host:</span> <span class="hljs-variable constant_">ENV</span>.fetch(<span class="hljs-string">'ISUCON13_MYSQL_DIALCONFIG_ADDRESS'</span>, <span class="hljs-string">'127.0.0.1'</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>50:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">port:</span> <span class="hljs-variable constant_">ENV</span>.fetch(<span class="hljs-string">'ISUCON13_MYSQL_DIALCONFIG_PORT'</span>, <span class="hljs-string">'3306'</span>).to_i,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>51:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">username:</span> <span class="hljs-variable constant_">ENV</span>.fetch(<span class="hljs-string">'ISUCON13_MYSQL_DIALCONFIG_USER'</span>, <span class="hljs-string">'isucon'</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>52:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">password:</span> <span class="hljs-variable constant_">ENV</span>.fetch(<span class="hljs-string">'ISUCON13_MYSQL_DIALCONFIG_PASSWORD'</span>, <span class="hljs-string">'isucon'</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>53:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">database:</span> <span class="hljs-variable constant_">ENV</span>.fetch(<span class="hljs-string">'ISUCON13_MYSQL_DIALCONFIG_DATABASE'</span>, <span class="hljs-string">'isupipe'</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>54:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">symbolize_keys:</span> <span class="hljs-literal">true</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>55:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">cast_booleans:</span> <span class="hljs-literal">true</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>56:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">reconnect:</span> <span class="hljs-literal">true</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>57:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        )
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>58:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>59:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>60:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">def</span> <span class="hljs-title function_">db_transaction</span>(<span class="hljs-params">&amp;block</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>3818</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>61:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        db_conn.query(<span class="hljs-string">'BEGIN'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>3818</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>62:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        ok = <span class="hljs-literal">false</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>63:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">begin</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>3818</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>64:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          retval = block.call(db_conn)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>3802</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>65:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          db_conn.query(<span class="hljs-string">'COMMIT'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>3802</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>66:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          ok = <span class="hljs-literal">true</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>3802</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>67:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          retval
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>68:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">ensure</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>3814</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>69:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">unless</span> ok
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>12</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>70:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            db_conn.query(<span class="hljs-string">'ROLLBACK'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>71:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>72:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>73:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>74:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>75:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">def</span> <span class="hljs-title function_">decode_request_body</span>(<span class="hljs-params">data_class</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p10">
  <div class="executed-count pure-u-2-24">
    <p>1727</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>76:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        body = <span class="hljs-variable constant_">JSON</span>.parse(request.body.tap(&amp;<span class="hljs-symbol">:rewind</span>).read, <span class="hljs-symbol">symbolize_names:</span> <span class="hljs-literal">true</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p40">
  <div class="executed-count pure-u-2-24">
    <p>6308</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>77:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        data_class.new(**data_class.members.map { |<span class="hljs-params">key</span>| [key, body[key]] }.to_h)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>78:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>79:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>80:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">def</span> <span class="hljs-title function_">cast_as_integer</span>(<span class="hljs-params">str</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>755</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>81:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-title class_">Integer</span>(str, <span class="hljs-number">10</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>82:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">rescue</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>83:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">400</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>84:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>85:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>86:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_user_session!</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1410</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>87:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        sess = session[<span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1410</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>88:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>89:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">403</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>90:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>91:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1410</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>92:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        session_expires = sess[<span class="hljs-variable constant_">DEFAULT_SESSION_EXPIRES_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1410</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>93:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">unless</span> session_expires
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>94:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">403</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>95:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>96:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1410</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>97:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        now = <span class="hljs-title class_">Time</span>.now
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1410</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>98:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">if</span> now.to_i &gt; session_expires
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>99:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>, <span class="hljs-string">'session has expired'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>100:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>101:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>102:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-literal">nil</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>103:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>104:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>105:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">def</span> <span class="hljs-title function_">fill_livestream_response</span>(<span class="hljs-params">tx, livestream_model</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>4714</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>106:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        owner_model = tx.xquery(<span class="hljs-string">'SELECT * FROM users WHERE id = ?'</span>, livestream_model.fetch(<span class="hljs-symbol">:user_id</span>)).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>4714</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>107:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        owner = fill_user_response(tx, owner_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>108:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>4714</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>109:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tags = tx.xquery(<span class="hljs-string">'SELECT * FROM livestream_tags WHERE livestream_id = ?'</span>, livestream_model.fetch(<span class="hljs-symbol">:id</span>)).map <span class="hljs-keyword">do</span> |<span class="hljs-params">livestream_tag_model</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p90">
  <div class="executed-count pure-u-2-24">
    <p>15757</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>110:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          tag_model = tx.xquery(<span class="hljs-string">'SELECT * FROM tags WHERE id = ?'</span>, livestream_tag_model.fetch(<span class="hljs-symbol">:tag_id</span>)).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>111:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          {
</pre>
    
  </div>
</div>

<div class="line pure-g count-p90">
  <div class="executed-count pure-u-2-24">
    <p>15757</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>112:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-symbol">id:</span> tag_model.fetch(<span class="hljs-symbol">:id</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>113:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-symbol">name:</span> tag_model.fetch(<span class="hljs-symbol">:name</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>114:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          }
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>115:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>116:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>4714</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>117:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestream_model.slice(<span class="hljs-symbol">:id</span>, <span class="hljs-symbol">:title</span>, <span class="hljs-symbol">:description</span>, <span class="hljs-symbol">:playlist_url</span>, <span class="hljs-symbol">:thumbnail_url</span>, <span class="hljs-symbol">:start_at</span>, <span class="hljs-symbol">:end_at</span>).merge(
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>118:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">owner:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>119:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">tags:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>120:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        )
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>121:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>122:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>123:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">def</span> <span class="hljs-title function_">fill_livecomment_response</span>(<span class="hljs-params">tx, livecomment_model</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1096</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>124:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        comment_owner_model = tx.xquery(<span class="hljs-string">'SELECT * FROM users WHERE id = ?'</span>, livecomment_model.fetch(<span class="hljs-symbol">:user_id</span>)).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1096</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>125:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        comment_owner = fill_user_response(tx, comment_owner_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>126:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1096</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>127:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestream_model = tx.xquery(<span class="hljs-string">'SELECT * FROM livestreams WHERE id = ?'</span>, livecomment_model.fetch(<span class="hljs-symbol">:livestream_id</span>)).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1096</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>128:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestream = fill_livestream_response(tx, livestream_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>129:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1096</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>130:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livecomment_model.slice(<span class="hljs-symbol">:id</span>, <span class="hljs-symbol">:comment</span>, <span class="hljs-symbol">:tip</span>, <span class="hljs-symbol">:created_at</span>).merge(
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>131:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">user:</span> comment_owner,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>132:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">livestream:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>133:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        )
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>134:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>135:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>136:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">def</span> <span class="hljs-title function_">fill_livecomment_report_response</span>(<span class="hljs-params">tx, report_model</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>62</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>137:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        reporter_model = tx.xquery(<span class="hljs-string">'SELECT * FROM users WHERE id = ?'</span>, report_model.fetch(<span class="hljs-symbol">:user_id</span>)).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>62</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>138:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        reporter = fill_user_response(tx, reporter_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>139:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>62</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>140:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livecomment_model = tx.xquery(<span class="hljs-string">'SELECT * FROM livecomments WHERE id = ?'</span>, report_model.fetch(<span class="hljs-symbol">:livecomment_id</span>)).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>62</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>141:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livecomment = fill_livecomment_response(tx, livecomment_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>142:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>62</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>143:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        report_model.slice(<span class="hljs-symbol">:id</span>, <span class="hljs-symbol">:created_at</span>).merge(
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>144:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">reporter:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>145:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">livecomment:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>146:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        )
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>147:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>148:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>149:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">def</span> <span class="hljs-title function_">fill_reaction_response</span>(<span class="hljs-params">tx, reaction_model</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>863</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>150:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        user_model = tx.xquery(<span class="hljs-string">'SELECT * FROM users WHERE id = ?'</span>, reaction_model.fetch(<span class="hljs-symbol">:user_id</span>)).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>863</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>151:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        user = fill_user_response(tx, user_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>152:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>863</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>153:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestream_model = tx.xquery(<span class="hljs-string">'SELECT * FROM livestreams WHERE id = ?'</span>, reaction_model.fetch(<span class="hljs-symbol">:livestream_id</span>)).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>863</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>154:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestream = fill_livestream_response(tx, livestream_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>155:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>863</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>156:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        reaction_model.slice(<span class="hljs-symbol">:id</span>, <span class="hljs-symbol">:emoji_name</span>, <span class="hljs-symbol">:created_at</span>).merge(
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>157:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">user:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>158:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">livestream:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>159:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        )
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>160:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>161:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>162:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">def</span> <span class="hljs-title function_">fill_user_response</span>(<span class="hljs-params">tx, user_model</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p40">
  <div class="executed-count pure-u-2-24">
    <p>7172</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>163:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        theme_model = tx.xquery(<span class="hljs-string">'SELECT * FROM themes WHERE user_id = ?'</span>, user_model.fetch(<span class="hljs-symbol">:id</span>)).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>164:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p40">
  <div class="executed-count pure-u-2-24">
    <p>7172</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>165:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        icon_model = tx.xquery(<span class="hljs-string">'SELECT image FROM icons WHERE user_id = ?'</span>, user_model.fetch(<span class="hljs-symbol">:id</span>)).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>166:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        image =
</pre>
    
  </div>
</div>

<div class="line pure-g count-p40">
  <div class="executed-count pure-u-2-24">
    <p>7172</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>167:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">if</span> icon_model
</pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>4712</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>168:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            icon_model.fetch(<span class="hljs-symbol">:image</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>169:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">else</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p10">
  <div class="executed-count pure-u-2-24">
    <p>2460</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>170:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-title class_">File</span>.binread(<span class="hljs-variable constant_">FALLBACK_IMAGE</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>171:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p40">
  <div class="executed-count pure-u-2-24">
    <p>7172</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>172:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        icon_hash = <span class="hljs-title class_">Digest</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:SHA256</span>.hexdigest(image)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>173:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>174:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        {
</pre>
    
  </div>
</div>

<div class="line pure-g count-p40">
  <div class="executed-count pure-u-2-24">
    <p>7172</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>175:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">id:</span> user_model.fetch(<span class="hljs-symbol">:id</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>176:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">name:</span> user_model.fetch(<span class="hljs-symbol">:name</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>177:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">display_name:</span> user_model.fetch(<span class="hljs-symbol">:display_name</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>178:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">description:</span> user_model.fetch(<span class="hljs-symbol">:description</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>179:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">theme:</span> {
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>180:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-symbol">id:</span> theme_model.fetch(<span class="hljs-symbol">:id</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>181:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-symbol">dark_mode:</span> theme_model.fetch(<span class="hljs-symbol">:dark_mode</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>182:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          },
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>183:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">icon_hash:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>184:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        }
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>185:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>186:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>187:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>188:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># 初期化</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>189:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    post <span class="hljs-string">'/api/initialize'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>190:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      out, status = <span class="hljs-title class_">Open3</span>.capture2e(<span class="hljs-string">'../sql/init.sh'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>191:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> status.success?
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>192:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        logger.warn(<span class="hljs-string">"init.sh failed with out=<span class="hljs-subst">#{out}</span>"</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>193:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        halt <span class="hljs-number">500</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>194:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>195:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>196:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>197:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-symbol">language:</span> <span class="hljs-string">'ruby'</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>198:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      )
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>199:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>200:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>201:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># top</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>202:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/tag'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>62</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>203:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      tag_models = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>62</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>204:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.query(<span class="hljs-string">'SELECT * FROM tags'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>205:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>206:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>62</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>207:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>208:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-symbol">tags:</span> tag_models.map { |<span class="hljs-params">tag_model</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>209:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          {
</pre>
    
  </div>
</div>

<div class="line pure-g count-p40">
  <div class="executed-count pure-u-2-24">
    <p>6386</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>210:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-symbol">id:</span> tag_model.fetch(<span class="hljs-symbol">:id</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>211:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-symbol">name:</span> tag_model.fetch(<span class="hljs-symbol">:name</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>212:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          }
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>213:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        },
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>214:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      )
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>215:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>216:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>217:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># 配信者のテーマ取得API</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>218:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/user/:username/theme'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>5</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>219:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>220:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>5</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>221:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      username = params[<span class="hljs-symbol">:username</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>222:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>5</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>223:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      theme_model = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>5</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>224:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        user_model = tx.xquery(<span class="hljs-string">'SELECT id FROM users WHERE name = ?'</span>, username).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>5</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>225:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">unless</span> user_model
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>226:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">404</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>227:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>5</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>228:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'SELECT * FROM themes WHERE user_id = ?'</span>, user_model.fetch(<span class="hljs-symbol">:id</span>)).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>229:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>230:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>5</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>231:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>232:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-symbol">id:</span> theme_model.fetch(<span class="hljs-symbol">:id</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>233:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-symbol">dark_mode:</span> theme_model.fetch(<span class="hljs-symbol">:dark_mode</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>234:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      )
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>235:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>236:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>237:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># livestream</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>238:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>239:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-title class_">ReserveLivestreamRequest</span> = <span class="hljs-title class_">Data</span>.define(
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>240:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:tags</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>241:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:title</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>242:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:description</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>243:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:playlist_url</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>244:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:thumbnail_url</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>245:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:start_at</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>246:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:end_at</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>247:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    )
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>248:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>249:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># reserve livestream</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>250:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    post <span class="hljs-string">'/api/livestream/reservation'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>84</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>251:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>84</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>252:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      sess = session[<span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>84</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>253:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>254:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>255:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>84</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>256:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user_id = sess[<span class="hljs-variable constant_">DEFAULT_USER_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>84</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>257:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>258:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>259:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>260:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>84</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>261:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      req = decode_request_body(<span class="hljs-title class_">ReserveLivestreamRequest</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>262:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>84</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>263:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestream = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>264:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-comment"># 2023/11/25 10:00からの１年間の期間内であるかチェック</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>84</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>265:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        term_start_at = <span class="hljs-title class_">Time</span>.utc(<span class="hljs-number">2023</span>, <span class="hljs-number">11</span>, <span class="hljs-number">25</span>, <span class="hljs-number">1</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>84</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>266:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        term_end_at = <span class="hljs-title class_">Time</span>.utc(<span class="hljs-number">2024</span>, <span class="hljs-number">11</span>, <span class="hljs-number">25</span>, <span class="hljs-number">1</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>84</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>267:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        reserve_start_at = <span class="hljs-title class_">Time</span>.at(req.start_at, <span class="hljs-symbol">in:</span> <span class="hljs-string">'UTC'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>84</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>268:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        reserve_end_at = <span class="hljs-title class_">Time</span>.at(req.end_at, <span class="hljs-symbol">in:</span> <span class="hljs-string">'UTC'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>84</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>269:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">if</span> reserve_start_at &gt;= term_end_at |<span class="hljs-params"></span>| reserve_end_at &lt;= term_start_at
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>270:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">400</span>, <span class="hljs-string">'bad reservation time range'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>271:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>272:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>273:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-comment"># 予約枠をみて、予約が可能か調べる</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>274:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> 並列な予約のoverbooking防止にFOR UPDATEが必要</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>82</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>275:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'SELECT * FROM reservation_slots WHERE start_at &gt;= ? AND end_at &lt;= ? FOR UPDATE'</span>, req.start_at, req.end_at).each <span class="hljs-keyword">do</span> |<span class="hljs-params">slot</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>629</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>276:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          count = tx.xquery(<span class="hljs-string">'SELECT slot FROM reservation_slots WHERE start_at = ? AND end_at = ?'</span>, slot.fetch(<span class="hljs-symbol">:start_at</span>), slot.fetch(<span class="hljs-symbol">:end_at</span>)).first.fetch(<span class="hljs-symbol">:slot</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>629</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>277:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          logger.info(<span class="hljs-string">"<span class="hljs-subst">#{slot.fetch(<span class="hljs-symbol">:start_at</span>)}</span> ~ <span class="hljs-subst">#{slot.fetch(<span class="hljs-symbol">:end_at</span>)}</span>予約枠の残数 = <span class="hljs-subst">#{slot.fetch(<span class="hljs-symbol">:slot</span>)}</span>"</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>629</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>278:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">if</span> count &lt; <span class="hljs-number">1</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>279:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">400</span>, <span class="hljs-string">"予約期間 <span class="hljs-subst">#{term_start_at.to_i}</span> ~ <span class="hljs-subst">#{term_end_at.to_i}</span>に対して、予約区間 <span class="hljs-subst">#{req.start_at}</span> ~ <span class="hljs-subst">#{req.end_at}</span>が予約できません"</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>280:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>281:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>282:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>81</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>283:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'UPDATE reservation_slots SET slot = slot - 1 WHERE start_at &gt;= ? AND end_at &lt;= ?'</span>, req.start_at, req.end_at)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>81</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>284:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'INSERT INTO livestreams (user_id, title, description, playlist_url, thumbnail_url, start_at, end_at) VALUES(?, ?, ?, ?, ?, ?, ?)'</span>, user_id, req.title, req.description, req.playlist_url, req.thumbnail_url, req.start_at, req.end_at)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>81</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>285:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestream_id = tx.last_id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>286:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>287:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">	<span class="hljs-comment"># タグ追加</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>81</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>288:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        req.tags.each <span class="hljs-keyword">do</span> |<span class="hljs-params">tag_id</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>327</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>289:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          tx.xquery(<span class="hljs-string">'INSERT INTO livestream_tags (livestream_id, tag_id) VALUES (?, ?)'</span>, livestream_id, tag_id)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>290:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>291:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>81</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>292:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        fill_livestream_response(tx, {
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>293:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">id:</span> livestream_id,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>294:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">user_id:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>295:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">title:</span> req.title,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>296:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">description:</span> req.description,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>297:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">playlist_url:</span> req.playlist_url,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>298:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">thumbnail_url:</span> req.thumbnail_url,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>299:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">start_at:</span> req.start_at,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>300:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">end_at:</span> req.end_at,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>301:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        })
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>302:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>303:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>81</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>304:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      status <span class="hljs-number">201</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>81</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>305:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(livestream)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>306:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>307:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>308:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># list livestream</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>309:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/livestream/search'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>35</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>310:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      key_tag_name = params[<span class="hljs-symbol">:tag</span>] |<span class="hljs-params"></span>| <span class="hljs-string">''</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>311:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>35</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>312:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestreams = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>313:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestream_models =
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>35</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>314:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">if</span> key_tag_name != <span class="hljs-string">''</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>315:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-comment"># タグによる取得</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>316:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            tag_id_list = tx.xquery(<span class="hljs-string">'SELECT id FROM tags WHERE name = ?'</span>, key_tag_name, <span class="hljs-symbol">as:</span> <span class="hljs-symbol">:array</span>).map(&amp;<span class="hljs-symbol">:first</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>317:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            tx.xquery(<span class="hljs-string">'SELECT * FROM livestream_tags WHERE tag_id IN (?) ORDER BY livestream_id DESC'</span>, tag_id_list).map <span class="hljs-keyword">do</span> |<span class="hljs-params">key_tagged_livestream</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1479</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>318:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">              tx.xquery(<span class="hljs-string">'SELECT * FROM livestreams WHERE id = ?'</span>, key_tagged_livestream.fetch(<span class="hljs-symbol">:livestream_id</span>)).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>319:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>320:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">else</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>321:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-comment"># 検索条件なし</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>22</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>322:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            query = <span class="hljs-string">'SELECT * FROM livestreams ORDER BY id DESC'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>22</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>323:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            limit_str = params[<span class="hljs-symbol">:limit</span>] |<span class="hljs-params"></span>| <span class="hljs-string">''</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>22</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>324:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-keyword">if</span> limit_str != <span class="hljs-string">''</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>22</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>325:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">              limit = cast_as_integer(limit_str)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>22</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>326:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">              query = <span class="hljs-string">"<span class="hljs-subst">#{query}</span> LIMIT <span class="hljs-subst">#{limit}</span>"</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>327:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>328:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>22</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>329:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            tx.xquery(query).to_a
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>330:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>331:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>35</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>332:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestream_models.map <span class="hljs-keyword">do</span> |<span class="hljs-params">livestream_model</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p10">
  <div class="executed-count pure-u-2-24">
    <p>2579</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>333:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          fill_livestream_response(tx, livestream_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>334:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>335:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>336:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>35</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>337:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(livestreams)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>338:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>339:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>340:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/livestream'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>76</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>341:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>76</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>342:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      sess = session[<span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>76</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>343:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>344:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>345:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>76</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>346:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user_id = sess[<span class="hljs-variable constant_">DEFAULT_USER_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>76</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>347:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>348:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>349:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>350:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>76</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>351:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestreams = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>76</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>352:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'SELECT * FROM livestreams WHERE user_id = ?'</span>, user_id).map <span class="hljs-keyword">do</span> |<span class="hljs-params">livestream_model</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>94</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>353:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          fill_livestream_response(tx, livestream_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>354:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>355:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>356:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>76</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>357:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(livestreams)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>358:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>359:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>360:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/user/:username/livestream'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>361:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>362:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      username = params[<span class="hljs-symbol">:username</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>363:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>364:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestreams = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>365:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        user = tx.xquery(<span class="hljs-string">'SELECT * FROM users WHERE name = ?'</span>, username).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>366:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">unless</span> user
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>367:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">404</span>, <span class="hljs-string">'user not found'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>368:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>369:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>370:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'SELECT * FROM livestreams WHERE user_id = ?'</span>, user.fetch(<span class="hljs-symbol">:id</span>)).map <span class="hljs-keyword">do</span> |<span class="hljs-params">livestream_model</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>371:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          fill_livestream_response(tx, livestream_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>372:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>373:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>374:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>375:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(livestreams)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>376:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>377:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>378:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># ユーザ視聴開始 (viewer)</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>379:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    post <span class="hljs-string">'/api/livestream/:livestream_id/enter'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>19</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>380:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>19</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>381:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      sess = session[<span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>19</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>382:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>383:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>384:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>19</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>385:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user_id = sess[<span class="hljs-variable constant_">DEFAULT_USER_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>19</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>386:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>387:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>388:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>389:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>19</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>390:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestream_id = cast_as_integer(params[<span class="hljs-symbol">:livestream_id</span>])
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>391:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>19</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>392:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>19</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>393:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        created_at = <span class="hljs-title class_">Time</span>.now.to_i
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>19</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>394:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'INSERT INTO livestream_viewers_history (user_id, livestream_id, created_at) VALUES(?, ?, ?)'</span>, user_id, livestream_id, created_at)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>395:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>396:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>19</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>397:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-string">''</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>398:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>399:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>400:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># ユーザ視聴終了 (viewer)</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>401:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    delete <span class="hljs-string">'/api/livestream/:livestream_id/exit'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>9</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>402:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>9</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>403:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      sess = session[<span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>9</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>404:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>405:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>406:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>9</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>407:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user_id = sess[<span class="hljs-variable constant_">DEFAULT_USER_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>9</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>408:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>409:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>410:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>411:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>9</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>412:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestream_id = cast_as_integer(params[<span class="hljs-symbol">:livestream_id</span>])
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>413:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>9</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>414:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>9</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>415:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'DELETE FROM livestream_viewers_history WHERE user_id = ? AND livestream_id = ?'</span>, user_id, livestream_id)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>416:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>417:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>9</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>418:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-string">''</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>419:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>420:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>421:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># get livestream</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>422:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/livestream/:livestream_id'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>423:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>424:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>425:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestream_id = cast_as_integer(params[<span class="hljs-symbol">:livestream_id</span>])
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>426:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>427:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestream = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>428:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestream_model = tx.xquery(<span class="hljs-string">'SELECT * FROM livestreams WHERE id = ?'</span>, livestream_id).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>429:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">unless</span> livestream_model
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>430:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">404</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>431:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>432:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>433:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        fill_livestream_response(tx, livestream_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>434:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>435:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>436:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(livestream)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>437:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>438:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>439:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># (配信者向け)ライブコメントの報告一覧取得API</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>440:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/livestream/:livestream_id/report'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>21</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>441:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>442:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>21</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>443:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      sess = session[<span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>21</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>444:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>445:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>446:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>21</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>447:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user_id = sess[<span class="hljs-variable constant_">DEFAULT_USER_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>21</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>448:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>449:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>450:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>451:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>21</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>452:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestream_id = cast_as_integer(params[<span class="hljs-symbol">:livestream_id</span>])
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>453:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>21</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>454:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      reports = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>21</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>455:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestream_model = tx.xquery(<span class="hljs-string">'SELECT * FROM livestreams WHERE id = ?'</span>, livestream_id).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>21</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>456:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">if</span> livestream_model.fetch(<span class="hljs-symbol">:user_id</span>) != user_id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>457:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">403</span>, <span class="hljs-string">"can't get other streamer's livecomment reports"</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>458:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>459:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>21</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>460:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'SELECT * FROM livecomment_reports WHERE livestream_id = ?'</span>, livestream_id).map <span class="hljs-keyword">do</span> |<span class="hljs-params">report_model</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>20</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>461:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          fill_livecomment_report_response(tx, report_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>462:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>463:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>464:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>21</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>465:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(reports)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>466:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>467:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>468:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># get polling livecomment timeline</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>469:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/livestream/:livestream_id/livecomment'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>160</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>470:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>160</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>471:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestream_id = cast_as_integer(params[<span class="hljs-symbol">:livestream_id</span>])
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>472:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>160</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>473:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livecomments = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>160</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>474:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        query = <span class="hljs-string">'SELECT * FROM livecomments WHERE livestream_id = ? ORDER BY created_at DESC'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>160</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>475:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        limit_str = params[<span class="hljs-symbol">:limit</span>] |<span class="hljs-params"></span>| <span class="hljs-string">''</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>160</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>476:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">if</span> limit_str != <span class="hljs-string">''</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>18</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>477:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          limit = cast_as_integer(limit_str)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>18</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>478:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          query = <span class="hljs-string">"<span class="hljs-subst">#{query}</span> LIMIT <span class="hljs-subst">#{limit}</span>"</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>479:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>480:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>160</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>481:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(query, livestream_id).map <span class="hljs-keyword">do</span> |<span class="hljs-params">livecomment_model</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>864</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>482:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          fill_livecomment_response(tx, livecomment_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>483:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>484:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>485:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>160</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>486:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(livecomments)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>487:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>488:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>489:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/livestream/:livestream_id/ngwords'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>15</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>490:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>15</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>491:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      sess = session[<span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>15</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>492:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>493:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>494:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>15</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>495:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user_id = sess[<span class="hljs-variable constant_">DEFAULT_USER_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>15</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>496:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>497:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>498:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>499:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>15</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>500:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestream_id = cast_as_integer(params[<span class="hljs-symbol">:livestream_id</span>])
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>501:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>15</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>502:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      ng_words = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>15</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>503:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'SELECT * FROM ng_words WHERE user_id = ? AND livestream_id = ? ORDER BY created_at DESC'</span>, user_id, livestream_id).to_a
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>504:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>505:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>15</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>506:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(ng_words)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>507:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>508:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>509:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-title class_">PostLivecommentRequest</span> = <span class="hljs-title class_">Data</span>.define(
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>510:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:comment</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>511:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:tip</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>512:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    )
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>513:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>514:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># ライブコメント投稿</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>515:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    post <span class="hljs-string">'/api/livestream/:livestream_id/livecomment'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>171</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>516:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>171</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>517:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      sess = session[<span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>171</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>518:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>519:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>520:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>171</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>521:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user_id = sess[<span class="hljs-variable constant_">DEFAULT_USER_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>171</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>522:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>523:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>524:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>525:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>171</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>526:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestream_id = cast_as_integer(params[<span class="hljs-symbol">:livestream_id</span>])
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>527:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>171</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>528:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      req = decode_request_body(<span class="hljs-title class_">PostLivecommentRequest</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>529:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>171</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>530:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livecomment = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>171</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>531:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestream_model = tx.xquery(<span class="hljs-string">'SELECT * FROM livestreams WHERE id = ?'</span>, livestream_id).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>171</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>532:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">unless</span> livestream_model
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>533:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">404</span>, <span class="hljs-string">'livestream not found'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>534:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>535:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>536:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-comment"># スパム判定</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>171</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>537:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'SELECT id, user_id, livestream_id, word FROM ng_words WHERE user_id = ? AND livestream_id = ?'</span>, livestream_model.fetch(<span class="hljs-symbol">:user_id</span>), livestream_model.fetch(<span class="hljs-symbol">:id</span>)).each <span class="hljs-keyword">do</span> |<span class="hljs-params">ng_word</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>33</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>538:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          query = &lt;&lt;~<span class="hljs-variable constant_">SQL</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>539:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-variable constant_">SELECT</span> <span class="hljs-variable constant_">COUNT</span>(*)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>540:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-variable constant_">FROM</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>541:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            (<span class="hljs-variable constant_">SELECT</span> ? <span class="hljs-variable constant_">AS</span> text) <span class="hljs-variable constant_">AS</span> texts
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>542:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-variable constant_">INNER</span> <span class="hljs-variable constant_">JOIN</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>543:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            (<span class="hljs-variable constant_">SELECT</span> <span class="hljs-variable constant_">CONCAT</span>(<span class="hljs-string">'%'</span>, <span class="hljs-string">?,</span> <span class="hljs-string">'%'</span>)	<span class="hljs-variable constant_">AS</span> pattern) <span class="hljs-variable constant_">AS</span> patterns
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>544:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-variable constant_">ON</span> texts.text <span class="hljs-variable constant_">LIKE</span> patterns.pattern
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>545:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">SQL</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>33</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>546:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          hit_spam = tx.xquery(query, req.comment, ng_word.fetch(<span class="hljs-symbol">:word</span>), <span class="hljs-symbol">as:</span> <span class="hljs-symbol">:array</span>).first[<span class="hljs-number">0</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>33</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>547:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          logger.info(<span class="hljs-string">"[hit_spam=<span class="hljs-subst">#{hit_spam}</span>] comment = <span class="hljs-subst">#{req.comment}</span>"</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>33</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>548:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">if</span> hit_spam &gt;= <span class="hljs-number">1</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>549:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">400</span>, <span class="hljs-string">'このコメントがスパム判定されました'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>550:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>551:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>552:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>170</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>553:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        now = <span class="hljs-title class_">Time</span>.now.to_i
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>170</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>554:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'INSERT INTO livecomments (user_id, livestream_id, comment, tip, created_at) VALUES (?, ?, ?, ?, ?)'</span>, user_id, livestream_id, req.comment, req.tip, now)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>170</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>555:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livecomment_id = tx.last_id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>556:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>170</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>557:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        fill_livecomment_response(tx, {
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>558:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">id:</span> livecomment_id,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>559:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">user_id:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>560:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">livestream_id:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>561:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">comment:</span> req.comment,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>562:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">tip:</span> req.tip,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>563:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">created_at:</span> now,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>564:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        })
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>565:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>566:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>170</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>567:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      status <span class="hljs-number">201</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>170</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>568:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(livecomment)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>569:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>570:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>571:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># ライブコメント報告</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>572:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    post <span class="hljs-string">'/api/livestream/:livestream_id/livecomment/:livecomment_id/report'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>48</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>573:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>48</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>574:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      sess = session[<span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>48</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>575:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>576:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>577:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>48</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>578:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user_id = sess[<span class="hljs-variable constant_">DEFAULT_USER_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>48</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>579:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> user_id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>580:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>581:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>582:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>48</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>583:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestream_id = cast_as_integer(params[<span class="hljs-symbol">:livestream_id</span>])
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>48</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>584:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livecomment_id = cast_as_integer(params[<span class="hljs-symbol">:livecomment_id</span>])
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>585:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>48</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>586:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      report = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>48</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>587:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestream_model = tx.xquery(<span class="hljs-string">'SELECT * FROM livestreams WHERE id = ?'</span>, livestream_id).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>48</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>588:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">unless</span> livestream_model
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>589:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">404</span>, <span class="hljs-string">'livestream not found'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>590:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>591:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>48</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>592:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livecomment_model = tx.xquery(<span class="hljs-string">'SELECT * FROM livecomments WHERE id = ?'</span>, livecomment_id).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>48</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>593:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">unless</span> livecomment_model
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>6</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>594:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">404</span>, <span class="hljs-string">'livecomment not found'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>595:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>596:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>42</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>597:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        now = <span class="hljs-title class_">Time</span>.now.to_i
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>42</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>598:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'INSERT INTO livecomment_reports(user_id, livestream_id, livecomment_id, created_at) VALUES (?, ?, ?, ?)'</span>, user_id, livestream_id, livecomment_id, now)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>42</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>599:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        report_id = tx.last_id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>600:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>42</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>601:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        fill_livecomment_report_response(tx, {
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>602:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">id:</span> report_id,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>603:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">user_id:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>604:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">livestream_id:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>605:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">livecomment_id:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>606:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">created_at:</span> now,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>607:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        })
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>608:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>609:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>42</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>610:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      status <span class="hljs-number">201</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>42</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>611:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(report)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>612:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>613:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>614:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-title class_">ModerateRequest</span> = <span class="hljs-title class_">Data</span>.define(<span class="hljs-symbol">:ng_word</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>615:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>616:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># 配信者によるモデレーション (NGワード登録)</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>617:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    post <span class="hljs-string">'/api/livestream/:livestream_id/moderate'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>618:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>619:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      sess = session[<span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>620:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>621:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>622:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>623:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user_id = sess[<span class="hljs-variable constant_">DEFAULT_USER_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>624:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> user_id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>625:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>626:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>627:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>628:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestream_id = cast_as_integer(params[<span class="hljs-symbol">:livestream_id</span>])
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>629:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>630:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      req = decode_request_body(<span class="hljs-title class_">ModerateRequest</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>631:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>632:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      word_id = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>633:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-comment"># 配信者自身の配信に対するmoderateなのかを検証</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>634:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        owned_livestreams = tx.xquery(<span class="hljs-string">'SELECT * FROM livestreams WHERE id = ? AND user_id = ?'</span>, livestream_id, user_id).to_a
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>635:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">if</span> owned_livestreams.empty?
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>636:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">400</span>, <span class="hljs-string">"A streamer can't moderate livestreams that other streamers own"</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>637:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>638:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>639:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'INSERT INTO ng_words(user_id, livestream_id, word, created_at) VALUES (?, ?, ?, ?)'</span>, user_id, livestream_id, req.ng_word, <span class="hljs-title class_">Time</span>.now.to_i)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>640:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        word_id = tx.last_id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>641:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>642:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-comment"># NGワードにヒットする過去の投稿も全削除する</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>643:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'SELECT * FROM ng_words WHERE livestream_id = ?'</span>, livestream_id).each <span class="hljs-keyword">do</span> |<span class="hljs-params">ng_word</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>644:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-comment"># ライブコメント一覧取得</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>14</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>645:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          tx.xquery(<span class="hljs-string">'SELECT * FROM livecomments'</span>).each <span class="hljs-keyword">do</span> |<span class="hljs-params">livecomment</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p90">
  <div class="executed-count pure-u-2-24">
    <p>15411</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>646:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            query = &lt;&lt;~<span class="hljs-variable constant_">SQL</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>647:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">              <span class="hljs-variable constant_">DELETE</span> <span class="hljs-variable constant_">FROM</span> livecomments
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>648:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">              <span class="hljs-variable constant_">WHERE</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>649:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">              id = ? <span class="hljs-variable constant_">AND</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>650:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">              livestream_id = ? <span class="hljs-variable constant_">AND</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>651:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">              (<span class="hljs-variable constant_">SELECT</span> <span class="hljs-variable constant_">COUNT</span>(*)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>652:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">              <span class="hljs-variable constant_">FROM</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>653:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">              (<span class="hljs-variable constant_">SELECT</span> ? <span class="hljs-variable constant_">AS</span> text) <span class="hljs-variable constant_">AS</span> texts
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>654:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">              <span class="hljs-variable constant_">INNER</span> <span class="hljs-variable constant_">JOIN</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>655:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">              (<span class="hljs-variable constant_">SELECT</span> <span class="hljs-variable constant_">CONCAT</span>(<span class="hljs-string">'%'</span>, <span class="hljs-string">?,</span> <span class="hljs-string">'%'</span>)	<span class="hljs-variable constant_">AS</span> pattern) <span class="hljs-variable constant_">AS</span> patterns
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>656:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">              <span class="hljs-variable constant_">ON</span> texts.text <span class="hljs-variable constant_">LIKE</span> patterns.pattern) &gt;= <span class="hljs-number">1</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>657:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-variable constant_">SQL</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p90">
  <div class="executed-count pure-u-2-24">
    <p>15411</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>658:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            tx.xquery(query, livecomment.fetch(<span class="hljs-symbol">:id</span>), livestream_id, livecomment.fetch(<span class="hljs-symbol">:comment</span>), ng_word.fetch(<span class="hljs-symbol">:word</span>))
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>659:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>660:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>661:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>662:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        word_id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>663:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>664:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>665:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      status <span class="hljs-number">201</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>13</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>666:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(<span class="hljs-symbol">word_id:</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>667:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>668:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>669:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/livestream/:livestream_id/reaction'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>191</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>670:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>671:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>191</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>672:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestream_id = cast_as_integer(params[<span class="hljs-symbol">:livestream_id</span>])
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>673:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>191</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>674:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      reactions = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>191</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>675:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        query = <span class="hljs-string">'SELECT * FROM reactions WHERE livestream_id = ? ORDER BY created_at DESC'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>191</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>676:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        limit_str = params[<span class="hljs-symbol">:limit</span>] |<span class="hljs-params"></span>| <span class="hljs-string">''</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>191</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>677:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">if</span> limit_str != <span class="hljs-string">''</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>17</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>678:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          limit = cast_as_integer(limit_str)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>17</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>679:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          query = <span class="hljs-string">"<span class="hljs-subst">#{query}</span> LIMIT <span class="hljs-subst">#{limit}</span>"</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>680:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>681:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>191</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>682:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(query, livestream_id).map <span class="hljs-keyword">do</span> |<span class="hljs-params">reaction_model</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>709</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>683:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          fill_reaction_response(tx, reaction_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>684:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>685:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>686:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>191</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>687:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(reactions)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>688:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>689:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>690:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-title class_">PostReactionRequest</span> = <span class="hljs-title class_">Data</span>.define(<span class="hljs-symbol">:emoji_name</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>691:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>692:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    post <span class="hljs-string">'/api/livestream/:livestream_id/reaction'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>154</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>693:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>154</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>694:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      sess = session[<span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>154</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>695:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>696:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>697:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>154</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>698:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user_id = sess[<span class="hljs-variable constant_">DEFAULT_USER_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>154</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>699:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> user_id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>700:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>701:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>702:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>154</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>703:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestream_id = <span class="hljs-title class_">Integer</span>(params[<span class="hljs-symbol">:livestream_id</span>], <span class="hljs-number">10</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>704:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>154</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>705:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      req = decode_request_body(<span class="hljs-title class_">PostReactionRequest</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>706:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>154</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>707:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      reaction = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>154</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>708:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        created_at = <span class="hljs-title class_">Time</span>.now.to_i
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>154</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>709:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'INSERT INTO reactions (user_id, livestream_id, emoji_name, created_at) VALUES (?, ?, ?, ?)'</span>, user_id, livestream_id, req.emoji_name, created_at)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>154</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>710:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        reaction_id = tx.last_id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>711:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>154</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>712:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        fill_reaction_response(tx, {
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>713:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">id:</span> reaction_id,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>714:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">user_id:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>715:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">livestream_id:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>716:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">emoji_name:</span> req.emoji_name,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>717:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">created_at:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>718:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        })
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>719:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>720:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>154</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>721:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      status <span class="hljs-number">201</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>154</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>722:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(reaction)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>723:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>724:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>725:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-variable constant_">BCRYPT_DEFAULT_COST</span> = <span class="hljs-number">4</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>726:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-variable constant_">FALLBACK_IMAGE</span> = <span class="hljs-string">'../img/NoImage.jpg'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>727:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>728:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/user/:username/icon'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1437</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>729:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      username = params[<span class="hljs-symbol">:username</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>730:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1437</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>731:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      image = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1437</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>732:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        user = tx.xquery(<span class="hljs-string">'SELECT * FROM users WHERE name = ?'</span>, username).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1437</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>733:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">unless</span> user
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>734:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">404</span>, <span class="hljs-string">'not found user that has the given username'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>735:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1437</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>736:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'SELECT image FROM icons WHERE user_id = ?'</span>, user.fetch(<span class="hljs-symbol">:id</span>)).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>737:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>738:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1437</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>739:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      content_type <span class="hljs-string">'image/jpeg'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1437</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>740:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">if</span> image
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>920</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>741:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        image[<span class="hljs-symbol">:image</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>742:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">else</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>517</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>743:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        send_file <span class="hljs-variable constant_">FALLBACK_IMAGE</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>744:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>745:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>746:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>747:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-title class_">PostIconRequest</span> = <span class="hljs-title class_">Data</span>.define(<span class="hljs-symbol">:image</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>748:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>749:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    post <span class="hljs-string">'/api/icon'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>431</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>750:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>751:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>431</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>752:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      sess = session[<span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>431</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>753:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>754:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>755:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>431</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>756:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user_id = sess[<span class="hljs-variable constant_">DEFAULT_USER_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>431</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>757:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> user_id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>758:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>759:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>760:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>431</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>761:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      req = decode_request_body(<span class="hljs-title class_">PostIconRequest</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>431</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>762:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      image = <span class="hljs-title class_">Base64</span>.decode64(req.image)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>763:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>431</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>764:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      icon_id = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>431</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>765:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'DELETE FROM icons WHERE user_id = ?'</span>, user_id)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>431</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>766:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'INSERT INTO icons (user_id, image) VALUES (?, ?)'</span>, user_id, image)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>431</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>767:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.last_id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>768:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>769:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>431</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>770:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      status <span class="hljs-number">201</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>431</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>771:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>772:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-symbol">id:</span> icon_id,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>773:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      )
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>774:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>775:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>776:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/user/me'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>3</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>777:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>778:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>3</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>779:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      sess = session[<span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>3</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>780:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> sess
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>781:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>782:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>3</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>783:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user_id = sess[<span class="hljs-variable constant_">DEFAULT_USER_ID_KEY</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>3</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>784:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> user_id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>785:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>786:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>787:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>3</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>788:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>3</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>789:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        user_model = tx.xquery(<span class="hljs-string">'SELECT * FROM users WHERE id = ?'</span>, user_id).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>3</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>790:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">unless</span> user_model
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>791:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">404</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>792:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>3</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>793:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        fill_user_response(tx, user_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>794:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>795:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>3</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>796:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(user)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>797:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>798:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>799:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-title class_">PostUserRequest</span> = <span class="hljs-title class_">Data</span>.define(
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>800:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:name</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>801:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:display_name</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>802:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:description</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>803:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-comment"># password is non-hashed password.</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>804:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:password</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>805:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:theme</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>806:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    )
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>807:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>808:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># ユーザ登録API</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>809:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    post <span class="hljs-string">'/api/register'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>435</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>810:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      req = decode_request_body(<span class="hljs-title class_">PostUserRequest</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>435</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>811:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">if</span> req.name == <span class="hljs-string">'pipe'</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>812:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">400</span>, <span class="hljs-string">"the username 'pipe' is reserved"</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>813:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>814:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>434</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>815:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      hashed_password = <span class="hljs-title class_">BCrypt</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:Password</span>.create(req.password, <span class="hljs-symbol">cost:</span> <span class="hljs-variable constant_">BCRYPT_DEFAULT_COST</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>816:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>434</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>817:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>434</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>818:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'INSERT INTO users (name, display_name, description, password) VALUES(?, ?, ?, ?)'</span>, req.name, req.display_name, req.description, hashed_password)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>433</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>819:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        user_id = tx.last_id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>820:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>433</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>821:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'INSERT INTO themes (user_id, dark_mode) VALUES(?, ?)'</span>, user_id, req.theme.fetch(<span class="hljs-symbol">:dark_mode</span>))
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>822:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>433</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>823:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        out, status = <span class="hljs-title class_">Open3</span>.capture2e(<span class="hljs-string">'pdnsutil'</span>, <span class="hljs-string">'add-record'</span>, <span class="hljs-string">'t.isucon.pw'</span>, req.name, <span class="hljs-string">'A'</span>, <span class="hljs-string">'0'</span>, <span class="hljs-variable constant_">POWERDNS_SUBDOMAIN_ADDRESS</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>433</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>824:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">unless</span> status.success?
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>825:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">500</span>, <span class="hljs-string">"pdnsutil failed with out=<span class="hljs-subst">#{out}</span>"</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>826:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>827:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>433</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>828:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        fill_user_response(tx, {
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>829:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">id:</span> user_id,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>830:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">name:</span> req.name,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>831:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">display_name:</span> req.display_name,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>832:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">description:</span> req.description,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>833:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        })
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>834:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>835:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>433</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>836:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      status <span class="hljs-number">201</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>433</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>837:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(user)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>838:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>839:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>840:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-title class_">LoginRequest</span> = <span class="hljs-title class_">Data</span>.define(
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>841:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:username</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>842:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-comment"># password is non-hashed password.</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>843:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-symbol">:password</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>844:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    )
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>845:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>846:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># ユーザログインAPI</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>847:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    post <span class="hljs-string">'/api/login'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>439</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>848:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      req = decode_request_body(<span class="hljs-title class_">LoginRequest</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>849:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>439</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>850:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user_model = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>851:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-comment"># usernameはUNIQUEなので、whereで一意に特定できる</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>439</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>852:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'SELECT * FROM users WHERE name = ?'</span>, req.username).first.tap <span class="hljs-keyword">do</span> |<span class="hljs-params">user_model</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>439</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>853:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">unless</span> user_model
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>854:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>, <span class="hljs-string">'invalid username or password'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>855:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>856:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>857:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>858:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>438</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>859:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">unless</span> <span class="hljs-title class_">BCrypt::Password</span>.new(user_model.fetch(<span class="hljs-symbol">:password</span>)).is_password?(req.password)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>860:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">401</span>, <span class="hljs-string">'invalid username or password'</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>861:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>862:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>437</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>863:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      session_end_at = <span class="hljs-title class_">Time</span>.now + <span class="hljs-number">10</span>*<span class="hljs-number">60</span>*<span class="hljs-number">60</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>437</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>864:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      session_id = <span class="hljs-title class_">SecureRandom</span>.uuid
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>437</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>865:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      session[<span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span>] = {
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>866:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-variable constant_">DEFAULT_SESSION_ID_KEY</span> =&gt; session_id,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>867:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-variable constant_">DEFAULT_USER_ID_KEY</span> =&gt; user_model.fetch(<span class="hljs-symbol">:id</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>868:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-variable constant_">DEFAULT_USERNAME_KEY</span> =&gt; user_model.fetch(<span class="hljs-symbol">:name</span>),
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>869:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-variable constant_">DEFAULT_SESSION_EXPIRES_KEY</span> =&gt; session_end_at.to_i,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>870:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      }
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>871:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>437</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>872:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-string">''</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>873:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>874:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>875:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># ユーザ詳細API</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>876:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/user/:username'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>877:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>878:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>879:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      username = params[<span class="hljs-symbol">:username</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>880:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>881:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      user = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>882:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        user_model = tx.xquery(<span class="hljs-string">'SELECT * FROM users WHERE name = ?'</span>, username).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>883:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">unless</span> user_model
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>884:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">404</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>885:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>886:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>887:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        fill_user_response(tx, user_model)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>888:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>889:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>890:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(user)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>891:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>892:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>893:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-title class_">UserRankingEntry</span> = <span class="hljs-title class_">Data</span>.define(<span class="hljs-symbol">:username</span>, <span class="hljs-symbol">:score</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>894:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>895:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/user/:username/statistics'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>6</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>896:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>897:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>6</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>898:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      username = params[<span class="hljs-symbol">:username</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>899:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>900:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-comment"># ユーザごとに、紐づく配信について、累計リアクション数、累計ライブコメント数、累計売上金額を算出</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>901:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-comment"># また、現在の合計視聴者数もだす</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>902:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>6</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>903:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      stats = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>6</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>904:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        user = tx.xquery(<span class="hljs-string">'SELECT * FROM users WHERE name = ?'</span>, username).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>6</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>905:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">unless</span> user
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>906:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">400</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>907:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>908:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>909:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-comment"># ランク算出</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>6</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>910:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        users = tx.xquery(<span class="hljs-string">'SELECT * FROM users'</span>).to_a
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>911:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>6</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>912:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        ranking = users.map <span class="hljs-keyword">do</span> |<span class="hljs-params">user</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>3871</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>913:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          reactions = tx.xquery(&lt;&lt;~<span class="hljs-variable constant_">SQL</span>, user.fetch(<span class="hljs-symbol">:id</span>), <span class="hljs-symbol">as:</span> <span class="hljs-symbol">:array</span>).first[<span class="hljs-number">0</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>914:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-variable constant_">SELECT</span> <span class="hljs-variable constant_">COUNT</span>(*) <span class="hljs-variable constant_">FROM</span> users u
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>915:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-variable constant_">INNER</span> <span class="hljs-variable constant_">JOIN</span> livestreams l <span class="hljs-variable constant_">ON</span> l.user_id = u.id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>916:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-variable constant_">INNER</span> <span class="hljs-variable constant_">JOIN</span> reactions r <span class="hljs-variable constant_">ON</span> r.livestream_id = l.id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>917:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-variable constant_">WHERE</span> u.id = ?
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>918:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">SQL</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>919:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>3871</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>920:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          tips = tx.xquery(&lt;&lt;~<span class="hljs-variable constant_">SQL</span>, user.fetch(<span class="hljs-symbol">:id</span>), <span class="hljs-symbol">as:</span> <span class="hljs-symbol">:array</span>).first[<span class="hljs-number">0</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>921:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-variable constant_">SELECT</span> <span class="hljs-variable constant_">IFNULL</span>(<span class="hljs-variable constant_">SUM</span>(l2.tip), <span class="hljs-number">0</span>) <span class="hljs-variable constant_">FROM</span> users u
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>922:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-variable constant_">INNER</span> <span class="hljs-variable constant_">JOIN</span> livestreams l <span class="hljs-variable constant_">ON</span> l.user_id = u.id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>923:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-variable constant_">INNER</span> <span class="hljs-variable constant_">JOIN</span> livecomments l2 <span class="hljs-variable constant_">ON</span> l2.livestream_id = l.id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>924:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            <span class="hljs-variable constant_">WHERE</span> u.id = ?
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>925:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">SQL</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>926:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>3867</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>927:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          score = reactions + tips
</pre>
    
  </div>
</div>

<div class="line pure-g count-p20">
  <div class="executed-count pure-u-2-24">
    <p>3867</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>928:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-title class_">UserRankingEntry</span>.new(<span class="hljs-symbol">username:</span> user.fetch(<span class="hljs-symbol">:name</span>), <span class="hljs-symbol">score:</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>929:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>930:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p10">
  <div class="executed-count pure-u-2-24">
    <p>2002</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>931:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        ranking.sort_by! { |<span class="hljs-params">entry</span>| [entry.score, entry.username] }
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>754</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>932:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        ridx = ranking.rindex { |<span class="hljs-params">entry</span>| entry.username == username }
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>933:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        rank = ranking.size - ridx
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>934:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>935:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-comment"># リアクション数</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>936:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        total_reactions = tx.xquery(&lt;&lt;~<span class="hljs-variable constant_">SQL</span>, username, <span class="hljs-symbol">as:</span> <span class="hljs-symbol">:array</span>).first[<span class="hljs-number">0</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>937:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">SELECT</span> <span class="hljs-variable constant_">COUNT</span>(*) <span class="hljs-variable constant_">FROM</span> users u
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>938:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">INNER</span> <span class="hljs-variable constant_">JOIN</span> livestreams l <span class="hljs-variable constant_">ON</span> l.user_id = u.id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>939:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">INNER</span> <span class="hljs-variable constant_">JOIN</span> reactions r <span class="hljs-variable constant_">ON</span> r.livestream_id = l.id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>940:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">WHERE</span> u.name = ?
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>941:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-variable constant_">SQL</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>942:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>943:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-comment"># ライブコメント数、チップ合計</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>944:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        total_livecomments = <span class="hljs-number">0</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>945:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        total_tip = <span class="hljs-number">0</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>946:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestreams = tx.xquery(<span class="hljs-string">'SELECT * FROM livestreams WHERE user_id = ?'</span>, user.fetch(<span class="hljs-symbol">:id</span>))
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>947:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestreams.each <span class="hljs-keyword">do</span> |<span class="hljs-params">livestream</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>18</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>948:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          tx.xquery(<span class="hljs-string">'SELECT * FROM livecomments WHERE livestream_id = ?'</span>, livestream.fetch(<span class="hljs-symbol">:id</span>)).each <span class="hljs-keyword">do</span> |<span class="hljs-params">livecomment</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>4</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>949:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            total_tip += livecomment.fetch(<span class="hljs-symbol">:tip</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>4</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>950:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">            total_livecomments += <span class="hljs-number">1</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>951:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>952:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>953:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>954:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-comment"># 合計視聴者数</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>955:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        viewers_count = <span class="hljs-number">0</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>956:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        livestreams.each <span class="hljs-keyword">do</span> |<span class="hljs-params">livestream</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>18</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>957:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          cnt = tx.xquery(<span class="hljs-string">'SELECT COUNT(*) FROM livestream_viewers_history WHERE livestream_id = ?'</span>, livestream.fetch(<span class="hljs-symbol">:id</span>), <span class="hljs-symbol">as:</span> <span class="hljs-symbol">:array</span>).first[<span class="hljs-number">0</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>18</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>958:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          viewers_count += cnt
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>959:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>960:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>961:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-comment"># お気に入り絵文字</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>962:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        favorite_emoji = tx.xquery(&lt;&lt;~<span class="hljs-variable constant_">SQL</span>, username).first&amp;.fetch(<span class="hljs-symbol">:emoji_name</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>963:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">SELECT</span> r.emoji_name
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>964:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">FROM</span> users u
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>965:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">INNER</span> <span class="hljs-variable constant_">JOIN</span> livestreams l <span class="hljs-variable constant_">ON</span> l.user_id = u.id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>966:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">INNER</span> <span class="hljs-variable constant_">JOIN</span> reactions r <span class="hljs-variable constant_">ON</span> r.livestream_id = l.id
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>967:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">WHERE</span> u.name = ?
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>968:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">GROUP</span> <span class="hljs-variable constant_">BY</span> emoji_name
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>969:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">ORDER</span> <span class="hljs-variable constant_">BY</span> <span class="hljs-variable constant_">COUNT</span>(*) <span class="hljs-variable constant_">DESC</span>, emoji_name <span class="hljs-variable constant_">DESC</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>970:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-variable constant_">LIMIT</span> <span class="hljs-number">1</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>971:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-variable constant_">SQL</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>972:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>973:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        {
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>974:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">rank:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>975:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">viewers_count:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>976:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">total_reactions:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>977:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">total_livecomments:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>978:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">total_tip:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>979:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">favorite_emoji:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>980:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        }
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>981:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>982:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>983:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(stats)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>984:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>985:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>986:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-title class_">LivestreamRankingEntry</span> = <span class="hljs-title class_">Data</span>.define(<span class="hljs-symbol">:livestream_id</span>, <span class="hljs-symbol">:score</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>987:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>988:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-comment"># ライブ配信統計情報</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>989:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/livestream/:livestream_id/statistics'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>990:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      verify_user_session!
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>991:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      livestream_id = cast_as_integer(params[<span class="hljs-symbol">:livestream_id</span>])
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>992:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>993:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      stats = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>994:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">unless</span> tx.xquery(<span class="hljs-string">'SELECT * FROM livestreams WHERE id = ?'</span>, livestream_id).first
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>995:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-keyword">raise</span> <span class="hljs-title class_">HttpError</span>.new(<span class="hljs-number">400</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>996:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>997:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>998:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-comment"># ランク算出</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>999:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        ranking = tx.xquery(<span class="hljs-string">'SELECT * FROM livestreams'</span>).map <span class="hljs-keyword">do</span> |<span class="hljs-params">livestream</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p90">
  <div class="executed-count pure-u-2-24">
    <p>14992</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1000:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          reactions = tx.xquery(<span class="hljs-string">'SELECT COUNT(*) FROM livestreams l INNER JOIN reactions r ON l.id = r.livestream_id WHERE l.id = ?'</span>, livestream.fetch(<span class="hljs-symbol">:id</span>), <span class="hljs-symbol">as:</span> <span class="hljs-symbol">:array</span>).first[<span class="hljs-number">0</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1001:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p90">
  <div class="executed-count pure-u-2-24">
    <p>14992</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1002:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          total_tips = tx.xquery(<span class="hljs-string">'SELECT IFNULL(SUM(l2.tip), 0) FROM livestreams l INNER JOIN livecomments l2 ON l.id = l2.livestream_id WHERE l.id = ?'</span>, livestream.fetch(<span class="hljs-symbol">:id</span>), <span class="hljs-symbol">as:</span> <span class="hljs-symbol">:array</span>).first[<span class="hljs-number">0</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1003:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p90">
  <div class="executed-count pure-u-2-24">
    <p>14992</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1004:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          score = reactions + total_tips
</pre>
    
  </div>
</div>

<div class="line pure-g count-p90">
  <div class="executed-count pure-u-2-24">
    <p>14992</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1005:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-title class_">LivestreamRankingEntry</span>.new(<span class="hljs-symbol">livestream_id:</span> livestream.fetch(<span class="hljs-symbol">:id</span>), <span class="hljs-symbol">score:</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1006:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p90">
  <div class="executed-count pure-u-2-24">
    <p>14994</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1007:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        ranking.sort_by! { |<span class="hljs-params">entry</span>| [entry.score, entry.livestream_id] }
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>944</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1008:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        ridx = ranking.rindex { |<span class="hljs-params">entry</span>| entry.livestream_id == livestream_id }
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1009:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        rank = ranking.size - ridx
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1010:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1011:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">	<span class="hljs-comment"># 視聴者数算出</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1012:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        viewers_count = tx.xquery(<span class="hljs-string">'SELECT COUNT(*) FROM livestreams l INNER JOIN livestream_viewers_history h ON h.livestream_id = l.id WHERE l.id = ?'</span>, livestream_id, <span class="hljs-symbol">as:</span> <span class="hljs-symbol">:array</span>).first[<span class="hljs-number">0</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1013:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1014:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">	<span class="hljs-comment"># 最大チップ額</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1015:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        max_tip = tx.xquery(<span class="hljs-string">'SELECT IFNULL(MAX(tip), 0) FROM livestreams l INNER JOIN livecomments l2 ON l2.livestream_id = l.id WHERE l.id = ?'</span>, livestream_id, <span class="hljs-symbol">as:</span> <span class="hljs-symbol">:array</span>).first[<span class="hljs-number">0</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1016:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1017:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">	<span class="hljs-comment"># リアクション数</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1018:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        total_reactions = tx.xquery(<span class="hljs-string">'SELECT COUNT(*) FROM livestreams l INNER JOIN reactions r ON r.livestream_id = l.id WHERE l.id = ?'</span>, livestream_id, <span class="hljs-symbol">as:</span> <span class="hljs-symbol">:array</span>).first[<span class="hljs-number">0</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1019:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1020:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">	<span class="hljs-comment"># スパム報告数</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1021:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        total_reports = tx.xquery(<span class="hljs-string">'SELECT COUNT(*) FROM livestreams l INNER JOIN livecomment_reports r ON r.livestream_id = l.id WHERE l.id = ?'</span>, livestream_id, <span class="hljs-symbol">as:</span> <span class="hljs-symbol">:array</span>).first[<span class="hljs-number">0</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1022:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1023:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        {
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1024:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">rank:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1025:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">viewers_count:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1026:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">max_tip:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1027:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">total_reactions:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1028:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">          <span class="hljs-symbol">total_reports:</span>,
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1029:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        }
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1030:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1031:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>2</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1032:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(stats)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1033:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1034:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>0</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1035:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    get <span class="hljs-string">'/api/payment'</span> <span class="hljs-keyword">do</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1036:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      total_tip = db_transaction <span class="hljs-keyword">do</span> |<span class="hljs-params">tx</span>|
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1037:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">        tx.xquery(<span class="hljs-string">'SELECT IFNULL(SUM(tip), 0) FROM livecomments'</span>, <span class="hljs-symbol">as:</span> <span class="hljs-symbol">:array</span>).first[<span class="hljs-number">0</span>]
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1038:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1039:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"></pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p>1</p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1040:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">      json(<span class="hljs-symbol">total_tip:</span>)
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1041:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">    <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1042:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes">  <span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

<div class="line pure-g count-p0">
  <div class="executed-count pure-u-2-24">
    <p></p>
  </div>
  <div class="lineno pure-u-2-24">
    <p>1043:</p>
  </div>
  <div class="code pure-u-20-24">
    <pre class="code language-ruby hljs" data-highlighted="yes"><span class="hljs-keyword">end</span>
</pre>
    
  </div>
</div>

      </div>
    </div>
    <script>
      document.querySelectorAll('pre.code').forEach(el => {
        hljs.highlightElement(el);
      });
    </script>
  

</body></html>
