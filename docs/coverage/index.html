<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Akainaa</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.12.3/application.js' type='text/javascript'></script>
    <link href='./assets/0.12.3/application.css' media='screen, projection, print' rel='stylesheet' type='text/css' />
    <link rel="shortcut icon" type="image/png" href="./assets/0.12.3/favicon_red.png" />
    <link rel="icon" type="image/png" href="./assets/0.12.3/favicon.png" />
  </head>

  <body>
    <div id="loading">
      <img src="./assets/0.12.3/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" class="hide">
      <div class="timestamp">Generated <abbr class="timeago" title="2024-05-06T18:22:10+09:00">2024-05-06T18:22:10+09:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent">
      <span class="red">
  74.85%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         678.7
       </span>
    </span> hits/line
    )
  </h2>

  <a name="AllFiles"></a>

  <div>
    <b>1</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>497</b> relevant lines,
    <span class="green"><b>372</b> lines covered</span> and
    <span class="red"><b>125</b> lines missed. </span>
    (<span class="red">
  74.85%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#be9b68763c778ef9074690948d2695d42c19f93f" class="src_link" title="app.rb">app.rb</a></td>
            <td class="red strong cell--number t-file__coverage">74.85 %</td>
            <td class="cell--number">1043</td>
            <td class="cell--number">497</td>
            <td class="cell--number">372</td>
            <td class="cell--number">125</td>
            <td class="cell--number">678.70</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>


        
      </div>

      <div id="footer">
        Generated by <a href="https://github.com/simplecov-ruby/simplecov">simplecov</a> v0.22.0
        and simplecov-html v0.12.3<br/>
        using hotspot
      </div>

      <div class="source_files">
      
        <div class="source_table" id="be9b68763c778ef9074690948d2695d42c19f93f">
  <div class="header">
    <h3>app.rb</h3>
    <h4>
      <span class="red">
  74.85%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>497</b> relevant lines.
      <span class="green"><b>372</b> lines covered</span> and
      <span class="red"><b>125</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            
            

            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            
            

            

            <code class="ruby">require &#39;base64&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            
            

            

            <code class="ruby">require &#39;bcrypt&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            
            

            

            <code class="ruby">require &#39;digest&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            
            

            

            <code class="ruby">require &#39;mysql2&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            
            

            

            <code class="ruby">require &#39;mysql2-cs-bind&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            
            

            

            <code class="ruby">require &#39;open3&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            
            

            

            <code class="ruby">require &#39;securerandom&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            
            

            

            <code class="ruby">require &#39;sinatra/base&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            
            

            

            <code class="ruby">require &#39;sinatra/json&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            
            

            

            <code class="ruby">module Isupipe</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            
            

            

            <code class="ruby">  class App &lt; Sinatra::Base</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            
            

            

            <code class="ruby">    enable :logging</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            
            

            

            <code class="ruby">    set :show_exceptions, :after_handler</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            
            

            

            <code class="ruby">    set :sessions, domain: &#39;u.isucon.dev&#39;, path: &#39;/&#39;, expire_after: 1000*60</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            
            

            

            <code class="ruby">    set :session_secret, ENV.fetch(&#39;ISUCON13_SESSION_SECRETKEY&#39;, &#39;isucon13_session_cookiestore_defaultsecret&#39;).unpack(&#39;H*&#39;)[0]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            
            

            

            <code class="ruby">    POWERDNS_SUBDOMAIN_ADDRESS = ENV.fetch(&#39;ISUCON13_POWERDNS_SUBDOMAIN_ADDRESS&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            
            

            

            <code class="ruby">    DEFAULT_SESSION_ID_KEY = &#39;SESSIONID&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            
            

            

            <code class="ruby">    DEFAULT_SESSION_EXPIRES_KEY = &#39;EXPIRES&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            
            

            

            <code class="ruby">    DEFAULT_USER_ID_KEY = &#39;USERID&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            
            

            

            <code class="ruby">    DEFAULT_USERNAME_KEY = &#39;USERNAME&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            
            

            

            <code class="ruby">    class HttpError &lt; StandardError</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            
            

            

            <code class="ruby">      attr_reader :code</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            
            

            

            <code class="ruby">      def initialize(code, message = nil)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="31">
            <span class="hits">13</span>
            

            

            <code class="ruby">        super(message || &quot;HTTP error #{code}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="32">
            <span class="hits">13</span>
            

            

            <code class="ruby">        @code = code</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            
            

            

            <code class="ruby">    error HttpError do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="37">
            <span class="hits">13</span>
            

            

            <code class="ruby">      e = env[&#39;sinatra.error&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="38">
            <span class="hits">13</span>
            

            

            <code class="ruby">      status e.code</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="39">
            <span class="hits">13</span>
            

            

            <code class="ruby">      json(error: e.message)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            
            

            

            <code class="ruby">    helpers do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            
            

            

            <code class="ruby">      def db_conn</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11450" data-linenumber="44">
            <span class="hits">11450</span>
            

            

            <code class="ruby">        Thread.current[:db_conn] ||= connect_db</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            
            

            

            <code class="ruby">      def connect_db</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="48">
            <span class="hits">21</span>
            

            

            <code class="ruby">        Mysql2::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            
            

            

            <code class="ruby">          host: ENV.fetch(&#39;ISUCON13_MYSQL_DIALCONFIG_ADDRESS&#39;, &#39;127.0.0.1&#39;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            
            

            

            <code class="ruby">          port: ENV.fetch(&#39;ISUCON13_MYSQL_DIALCONFIG_PORT&#39;, &#39;3306&#39;).to_i,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            
            

            

            <code class="ruby">          username: ENV.fetch(&#39;ISUCON13_MYSQL_DIALCONFIG_USER&#39;, &#39;isucon&#39;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            
            

            

            <code class="ruby">          password: ENV.fetch(&#39;ISUCON13_MYSQL_DIALCONFIG_PASSWORD&#39;, &#39;isucon&#39;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            
            

            

            <code class="ruby">          database: ENV.fetch(&#39;ISUCON13_MYSQL_DIALCONFIG_DATABASE&#39;, &#39;isupipe&#39;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            
            

            

            <code class="ruby">          symbolize_keys: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            
            

            

            <code class="ruby">          cast_booleans: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            
            

            

            <code class="ruby">          reconnect: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            
            

            

            <code class="ruby">      def db_transaction(&amp;block)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3818" data-linenumber="61">
            <span class="hits">3818</span>
            

            

            <code class="ruby">        db_conn.query(&#39;BEGIN&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3818" data-linenumber="62">
            <span class="hits">3818</span>
            

            

            <code class="ruby">        ok = false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3818" data-linenumber="64">
            <span class="hits">3818</span>
            

            

            <code class="ruby">          retval = block.call(db_conn)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3802" data-linenumber="65">
            <span class="hits">3802</span>
            

            

            <code class="ruby">          db_conn.query(&#39;COMMIT&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3802" data-linenumber="66">
            <span class="hits">3802</span>
            

            

            <code class="ruby">          ok = true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3802" data-linenumber="67">
            <span class="hits">3802</span>
            

            

            <code class="ruby">          retval</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            
            

            

            <code class="ruby">        ensure</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3814" data-linenumber="69">
            <span class="hits">3814</span>
            

            

            <code class="ruby">          unless ok</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="70">
            <span class="hits">12</span>
            

            

            <code class="ruby">            db_conn.query(&#39;ROLLBACK&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            
            

            

            <code class="ruby">      def decode_request_body(data_class)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1727" data-linenumber="76">
            <span class="hits">1727</span>
            

            

            <code class="ruby">        body = JSON.parse(request.body.tap(&amp;:rewind).read, symbolize_names: true)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6308" data-linenumber="77">
            <span class="hits">6308</span>
            

            

            <code class="ruby">        data_class.new(**data_class.members.map { |key| [key, body[key]] }.to_h)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            
            

            

            <code class="ruby">      def cast_as_integer(str)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="755" data-linenumber="81">
            <span class="hits">755</span>
            

            

            <code class="ruby">        Integer(str, 10)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            
            

            

            <code class="ruby">      rescue</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            
            

            

            <code class="ruby">        raise HttpError.new(400)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            
            

            

            <code class="ruby">      def verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1410" data-linenumber="87">
            <span class="hits">1410</span>
            

            

            <code class="ruby">        sess = session[DEFAULT_SESSION_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1410" data-linenumber="88">
            <span class="hits">1410</span>
            

            

            <code class="ruby">        unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            
            

            

            <code class="ruby">          raise HttpError.new(403)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1410" data-linenumber="92">
            <span class="hits">1410</span>
            

            

            <code class="ruby">        session_expires = sess[DEFAULT_SESSION_EXPIRES_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1410" data-linenumber="93">
            <span class="hits">1410</span>
            

            

            <code class="ruby">        unless session_expires</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            
            

            

            <code class="ruby">          raise HttpError.new(403)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1410" data-linenumber="97">
            <span class="hits">1410</span>
            

            

            <code class="ruby">        now = Time.now</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1410" data-linenumber="98">
            <span class="hits">1410</span>
            

            

            <code class="ruby">        if now.to_i &gt; session_expires</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            
            

            

            <code class="ruby">          raise HttpError.new(401, &#39;session has expired&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            
            

            

            <code class="ruby">        nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            
            

            

            <code class="ruby">      def fill_livestream_response(tx, livestream_model)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4714" data-linenumber="106">
            <span class="hits">4714</span>
            

            

            <code class="ruby">        owner_model = tx.xquery(&#39;SELECT * FROM users WHERE id = ?&#39;, livestream_model.fetch(:user_id)).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4714" data-linenumber="107">
            <span class="hits">4714</span>
            

            

            <code class="ruby">        owner = fill_user_response(tx, owner_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4714" data-linenumber="109">
            <span class="hits">4714</span>
            

            

            <code class="ruby">        tags = tx.xquery(&#39;SELECT * FROM livestream_tags WHERE livestream_id = ?&#39;, livestream_model.fetch(:id)).map do |livestream_tag_model|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15757" data-linenumber="110">
            <span class="hits">15757</span>
            

            

            <code class="ruby">          tag_model = tx.xquery(&#39;SELECT * FROM tags WHERE id = ?&#39;, livestream_tag_model.fetch(:tag_id)).first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15757" data-linenumber="112">
            <span class="hits">15757</span>
            

            

            <code class="ruby">            id: tag_model.fetch(:id),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            
            

            

            <code class="ruby">            name: tag_model.fetch(:name),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4714" data-linenumber="117">
            <span class="hits">4714</span>
            

            

            <code class="ruby">        livestream_model.slice(:id, :title, :description, :playlist_url, :thumbnail_url, :start_at, :end_at).merge(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            
            

            

            <code class="ruby">          owner:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            
            

            

            <code class="ruby">          tags:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            
            

            

            <code class="ruby">      def fill_livecomment_response(tx, livecomment_model)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1096" data-linenumber="124">
            <span class="hits">1096</span>
            

            

            <code class="ruby">        comment_owner_model = tx.xquery(&#39;SELECT * FROM users WHERE id = ?&#39;, livecomment_model.fetch(:user_id)).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1096" data-linenumber="125">
            <span class="hits">1096</span>
            

            

            <code class="ruby">        comment_owner = fill_user_response(tx, comment_owner_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1096" data-linenumber="127">
            <span class="hits">1096</span>
            

            

            <code class="ruby">        livestream_model = tx.xquery(&#39;SELECT * FROM livestreams WHERE id = ?&#39;, livecomment_model.fetch(:livestream_id)).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1096" data-linenumber="128">
            <span class="hits">1096</span>
            

            

            <code class="ruby">        livestream = fill_livestream_response(tx, livestream_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1096" data-linenumber="130">
            <span class="hits">1096</span>
            

            

            <code class="ruby">        livecomment_model.slice(:id, :comment, :tip, :created_at).merge(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            
            

            

            <code class="ruby">          user: comment_owner,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            
            

            

            <code class="ruby">          livestream:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            
            

            

            <code class="ruby">      def fill_livecomment_report_response(tx, report_model)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="62" data-linenumber="137">
            <span class="hits">62</span>
            

            

            <code class="ruby">        reporter_model = tx.xquery(&#39;SELECT * FROM users WHERE id = ?&#39;, report_model.fetch(:user_id)).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="62" data-linenumber="138">
            <span class="hits">62</span>
            

            

            <code class="ruby">        reporter = fill_user_response(tx, reporter_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="62" data-linenumber="140">
            <span class="hits">62</span>
            

            

            <code class="ruby">        livecomment_model = tx.xquery(&#39;SELECT * FROM livecomments WHERE id = ?&#39;, report_model.fetch(:livecomment_id)).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="62" data-linenumber="141">
            <span class="hits">62</span>
            

            

            <code class="ruby">        livecomment = fill_livecomment_response(tx, livecomment_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="62" data-linenumber="143">
            <span class="hits">62</span>
            

            

            <code class="ruby">        report_model.slice(:id, :created_at).merge(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            
            

            

            <code class="ruby">          reporter:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            
            

            

            <code class="ruby">          livecomment:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            
            

            

            <code class="ruby">      def fill_reaction_response(tx, reaction_model)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="863" data-linenumber="150">
            <span class="hits">863</span>
            

            

            <code class="ruby">        user_model = tx.xquery(&#39;SELECT * FROM users WHERE id = ?&#39;, reaction_model.fetch(:user_id)).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="863" data-linenumber="151">
            <span class="hits">863</span>
            

            

            <code class="ruby">        user = fill_user_response(tx, user_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="863" data-linenumber="153">
            <span class="hits">863</span>
            

            

            <code class="ruby">        livestream_model = tx.xquery(&#39;SELECT * FROM livestreams WHERE id = ?&#39;, reaction_model.fetch(:livestream_id)).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="863" data-linenumber="154">
            <span class="hits">863</span>
            

            

            <code class="ruby">        livestream = fill_livestream_response(tx, livestream_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="863" data-linenumber="156">
            <span class="hits">863</span>
            

            

            <code class="ruby">        reaction_model.slice(:id, :emoji_name, :created_at).merge(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            
            

            

            <code class="ruby">          user:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            
            

            

            <code class="ruby">          livestream:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            
            

            

            <code class="ruby">      def fill_user_response(tx, user_model)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7172" data-linenumber="163">
            <span class="hits">7172</span>
            

            

            <code class="ruby">        theme_model = tx.xquery(&#39;SELECT * FROM themes WHERE user_id = ?&#39;, user_model.fetch(:id)).first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7172" data-linenumber="165">
            <span class="hits">7172</span>
            

            

            <code class="ruby">        icon_model = tx.xquery(&#39;SELECT image FROM icons WHERE user_id = ?&#39;, user_model.fetch(:id)).first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            
            

            

            <code class="ruby">        image =</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7172" data-linenumber="167">
            <span class="hits">7172</span>
            

            

            <code class="ruby">          if icon_model</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4712" data-linenumber="168">
            <span class="hits">4712</span>
            

            

            <code class="ruby">            icon_model.fetch(:image)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2460" data-linenumber="170">
            <span class="hits">2460</span>
            

            

            <code class="ruby">            File.binread(FALLBACK_IMAGE)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7172" data-linenumber="172">
            <span class="hits">7172</span>
            

            

            <code class="ruby">        icon_hash = Digest::SHA256.hexdigest(image)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="173">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7172" data-linenumber="175">
            <span class="hits">7172</span>
            

            

            <code class="ruby">          id: user_model.fetch(:id),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            
            

            

            <code class="ruby">          name: user_model.fetch(:name),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            
            

            

            <code class="ruby">          display_name: user_model.fetch(:display_name),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            
            

            

            <code class="ruby">          description: user_model.fetch(:description),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            
            

            

            <code class="ruby">          theme: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            
            

            

            <code class="ruby">            id: theme_model.fetch(:id),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            
            

            

            <code class="ruby">            dark_mode: theme_model.fetch(:dark_mode),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            
            

            

            <code class="ruby">          },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            
            

            

            <code class="ruby">          icon_hash:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="186">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            
            

            

            <code class="ruby">    # 初期化</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            
            

            

            <code class="ruby">    post &#39;/api/initialize&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="190">
            <span class="hits">1</span>
            

            

            <code class="ruby">      out, status = Open3.capture2e(&#39;../sql/init.sh&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="191">
            <span class="hits">1</span>
            

            

            <code class="ruby">      unless status.success?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            
            

            

            <code class="ruby">        logger.warn(&quot;init.sh failed with out=#{out}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            
            

            

            <code class="ruby">        halt 500</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="194">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="195">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="196">
            <span class="hits">1</span>
            

            

            <code class="ruby">      json(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            
            

            

            <code class="ruby">        language: &#39;ruby&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="198">
            
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="200">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            
            

            

            <code class="ruby">    # top</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            
            

            

            <code class="ruby">    get &#39;/api/tag&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="62" data-linenumber="203">
            <span class="hits">62</span>
            

            

            <code class="ruby">      tag_models = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="62" data-linenumber="204">
            <span class="hits">62</span>
            

            

            <code class="ruby">        tx.query(&#39;SELECT * FROM tags&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="205">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="62" data-linenumber="207">
            <span class="hits">62</span>
            

            

            <code class="ruby">      json(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="208">
            
            

            

            <code class="ruby">        tags: tag_models.map { |tag_model|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="209">
            
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6386" data-linenumber="210">
            <span class="hits">6386</span>
            

            

            <code class="ruby">            id: tag_model.fetch(:id),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="211">
            
            

            

            <code class="ruby">            name: tag_model.fetch(:name),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="212">
            
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="213">
            
            

            

            <code class="ruby">        },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="214">
            
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="215">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="216">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="217">
            
            

            

            <code class="ruby">    # 配信者のテーマ取得API</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="218">
            
            

            

            <code class="ruby">    get &#39;/api/user/:username/theme&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="219">
            <span class="hits">5</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="220">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="221">
            <span class="hits">5</span>
            

            

            <code class="ruby">      username = params[:username]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="222">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="223">
            <span class="hits">5</span>
            

            

            <code class="ruby">      theme_model = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="224">
            <span class="hits">5</span>
            

            

            <code class="ruby">        user_model = tx.xquery(&#39;SELECT id FROM users WHERE name = ?&#39;, username).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="225">
            <span class="hits">5</span>
            

            

            <code class="ruby">        unless user_model</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            
            

            

            <code class="ruby">          raise HttpError.new(404)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="227">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="228">
            <span class="hits">5</span>
            

            

            <code class="ruby">        tx.xquery(&#39;SELECT * FROM themes WHERE user_id = ?&#39;, user_model.fetch(:id)).first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="229">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="231">
            <span class="hits">5</span>
            

            

            <code class="ruby">      json(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="232">
            
            

            

            <code class="ruby">        id: theme_model.fetch(:id),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            
            

            

            <code class="ruby">        dark_mode: theme_model.fetch(:dark_mode),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="234">
            
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="235">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="236">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="237">
            
            

            

            <code class="ruby">    # livestream</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="238">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="239">
            
            

            

            <code class="ruby">    ReserveLivestreamRequest = Data.define(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="240">
            
            

            

            <code class="ruby">      :tags,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="241">
            
            

            

            <code class="ruby">      :title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="242">
            
            

            

            <code class="ruby">      :description,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="243">
            
            

            

            <code class="ruby">      :playlist_url,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="244">
            
            

            

            <code class="ruby">      :thumbnail_url,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="245">
            
            

            

            <code class="ruby">      :start_at,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="246">
            
            

            

            <code class="ruby">      :end_at,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="247">
            
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="248">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="249">
            
            

            

            <code class="ruby">    # reserve livestream</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="250">
            
            

            

            <code class="ruby">    post &#39;/api/livestream/reservation&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="251">
            <span class="hits">84</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="252">
            <span class="hits">84</span>
            

            

            <code class="ruby">      sess = session[DEFAULT_SESSION_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="253">
            <span class="hits">84</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="254">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="255">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="256">
            <span class="hits">84</span>
            

            

            <code class="ruby">      user_id = sess[DEFAULT_USER_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="257">
            <span class="hits">84</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="258">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="259">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="260">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="261">
            <span class="hits">84</span>
            

            

            <code class="ruby">      req = decode_request_body(ReserveLivestreamRequest)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="262">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="263">
            <span class="hits">84</span>
            

            

            <code class="ruby">      livestream = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="264">
            
            

            

            <code class="ruby">        # 2023/11/25 10:00からの１年間の期間内であるかチェック</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="265">
            <span class="hits">84</span>
            

            

            <code class="ruby">        term_start_at = Time.utc(2023, 11, 25, 1)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="266">
            <span class="hits">84</span>
            

            

            <code class="ruby">        term_end_at = Time.utc(2024, 11, 25, 1)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="267">
            <span class="hits">84</span>
            

            

            <code class="ruby">        reserve_start_at = Time.at(req.start_at, in: &#39;UTC&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="268">
            <span class="hits">84</span>
            

            

            <code class="ruby">        reserve_end_at = Time.at(req.end_at, in: &#39;UTC&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="269">
            <span class="hits">84</span>
            

            

            <code class="ruby">        if reserve_start_at &gt;= term_end_at || reserve_end_at &lt;= term_start_at</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="270">
            <span class="hits">2</span>
            

            

            <code class="ruby">          raise HttpError.new(400, &#39;bad reservation time range&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="271">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="272">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="273">
            
            

            

            <code class="ruby">        # 予約枠をみて、予約が可能か調べる</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="274">
            
            

            

            <code class="ruby">        # NOTE: 並列な予約のoverbooking防止にFOR UPDATEが必要</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="82" data-linenumber="275">
            <span class="hits">82</span>
            

            

            <code class="ruby">        tx.xquery(&#39;SELECT * FROM reservation_slots WHERE start_at &gt;= ? AND end_at &lt;= ? FOR UPDATE&#39;, req.start_at, req.end_at).each do |slot|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="629" data-linenumber="276">
            <span class="hits">629</span>
            

            

            <code class="ruby">          count = tx.xquery(&#39;SELECT slot FROM reservation_slots WHERE start_at = ? AND end_at = ?&#39;, slot.fetch(:start_at), slot.fetch(:end_at)).first.fetch(:slot)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="629" data-linenumber="277">
            <span class="hits">629</span>
            

            

            <code class="ruby">          logger.info(&quot;#{slot.fetch(:start_at)} ~ #{slot.fetch(:end_at)}予約枠の残数 = #{slot.fetch(:slot)}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="629" data-linenumber="278">
            <span class="hits">629</span>
            

            

            <code class="ruby">          if count &lt; 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="279">
            <span class="hits">1</span>
            

            

            <code class="ruby">            raise HttpError.new(400, &quot;予約期間 #{term_start_at.to_i} ~ #{term_end_at.to_i}に対して、予約区間 #{req.start_at} ~ #{req.end_at}が予約できません&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="280">
            
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="281">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="282">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="81" data-linenumber="283">
            <span class="hits">81</span>
            

            

            <code class="ruby">        tx.xquery(&#39;UPDATE reservation_slots SET slot = slot - 1 WHERE start_at &gt;= ? AND end_at &lt;= ?&#39;, req.start_at, req.end_at)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="81" data-linenumber="284">
            <span class="hits">81</span>
            

            

            <code class="ruby">        tx.xquery(&#39;INSERT INTO livestreams (user_id, title, description, playlist_url, thumbnail_url, start_at, end_at) VALUES(?, ?, ?, ?, ?, ?, ?)&#39;, user_id, req.title, req.description, req.playlist_url, req.thumbnail_url, req.start_at, req.end_at)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="81" data-linenumber="285">
            <span class="hits">81</span>
            

            

            <code class="ruby">        livestream_id = tx.last_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="286">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="287">
            
            

            

            <code class="ruby">	# タグ追加</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="81" data-linenumber="288">
            <span class="hits">81</span>
            

            

            <code class="ruby">        req.tags.each do |tag_id|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="327" data-linenumber="289">
            <span class="hits">327</span>
            

            

            <code class="ruby">          tx.xquery(&#39;INSERT INTO livestream_tags (livestream_id, tag_id) VALUES (?, ?)&#39;, livestream_id, tag_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="290">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="291">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="81" data-linenumber="292">
            <span class="hits">81</span>
            

            

            <code class="ruby">        fill_livestream_response(tx, {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="293">
            
            

            

            <code class="ruby">          id: livestream_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="294">
            
            

            

            <code class="ruby">          user_id:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="295">
            
            

            

            <code class="ruby">          title: req.title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="296">
            
            

            

            <code class="ruby">          description: req.description,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="297">
            
            

            

            <code class="ruby">          playlist_url: req.playlist_url,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="298">
            
            

            

            <code class="ruby">          thumbnail_url: req.thumbnail_url,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="299">
            
            

            

            <code class="ruby">          start_at: req.start_at,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="300">
            
            

            

            <code class="ruby">          end_at: req.end_at,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="301">
            
            

            

            <code class="ruby">        })</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="302">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="303">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="81" data-linenumber="304">
            <span class="hits">81</span>
            

            

            <code class="ruby">      status 201</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="81" data-linenumber="305">
            <span class="hits">81</span>
            

            

            <code class="ruby">      json(livestream)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="306">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="307">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="308">
            
            

            

            <code class="ruby">    # list livestream</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="309">
            
            

            

            <code class="ruby">    get &#39;/api/livestream/search&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="310">
            <span class="hits">35</span>
            

            

            <code class="ruby">      key_tag_name = params[:tag] || &#39;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="311">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="312">
            <span class="hits">35</span>
            

            

            <code class="ruby">      livestreams = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="313">
            
            

            

            <code class="ruby">        livestream_models =</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="314">
            <span class="hits">35</span>
            

            

            <code class="ruby">          if key_tag_name != &#39;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="315">
            
            

            

            <code class="ruby">            # タグによる取得</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="316">
            <span class="hits">13</span>
            

            

            <code class="ruby">            tag_id_list = tx.xquery(&#39;SELECT id FROM tags WHERE name = ?&#39;, key_tag_name, as: :array).map(&amp;:first)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="317">
            <span class="hits">13</span>
            

            

            <code class="ruby">            tx.xquery(&#39;SELECT * FROM livestream_tags WHERE tag_id IN (?) ORDER BY livestream_id DESC&#39;, tag_id_list).map do |key_tagged_livestream|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1479" data-linenumber="318">
            <span class="hits">1479</span>
            

            

            <code class="ruby">              tx.xquery(&#39;SELECT * FROM livestreams WHERE id = ?&#39;, key_tagged_livestream.fetch(:livestream_id)).first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="319">
            
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="320">
            
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="321">
            
            

            

            <code class="ruby">            # 検索条件なし</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="322">
            <span class="hits">22</span>
            

            

            <code class="ruby">            query = &#39;SELECT * FROM livestreams ORDER BY id DESC&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="323">
            <span class="hits">22</span>
            

            

            <code class="ruby">            limit_str = params[:limit] || &#39;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="324">
            <span class="hits">22</span>
            

            

            <code class="ruby">            if limit_str != &#39;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="325">
            <span class="hits">22</span>
            

            

            <code class="ruby">              limit = cast_as_integer(limit_str)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="326">
            <span class="hits">22</span>
            

            

            <code class="ruby">              query = &quot;#{query} LIMIT #{limit}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="327">
            
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="328">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="329">
            <span class="hits">22</span>
            

            

            <code class="ruby">            tx.xquery(query).to_a</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="330">
            
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="331">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="332">
            <span class="hits">35</span>
            

            

            <code class="ruby">        livestream_models.map do |livestream_model|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2579" data-linenumber="333">
            <span class="hits">2579</span>
            

            

            <code class="ruby">          fill_livestream_response(tx, livestream_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="334">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="335">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="336">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="337">
            <span class="hits">35</span>
            

            

            <code class="ruby">      json(livestreams)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="338">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="339">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="340">
            
            

            

            <code class="ruby">    get &#39;/api/livestream&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="341">
            <span class="hits">76</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="342">
            <span class="hits">76</span>
            

            

            <code class="ruby">      sess = session[DEFAULT_SESSION_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="343">
            <span class="hits">76</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="344">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="345">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="346">
            <span class="hits">76</span>
            

            

            <code class="ruby">      user_id = sess[DEFAULT_USER_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="347">
            <span class="hits">76</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="348">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="349">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="350">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="351">
            <span class="hits">76</span>
            

            

            <code class="ruby">      livestreams = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="352">
            <span class="hits">76</span>
            

            

            <code class="ruby">        tx.xquery(&#39;SELECT * FROM livestreams WHERE user_id = ?&#39;, user_id).map do |livestream_model|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="94" data-linenumber="353">
            <span class="hits">94</span>
            

            

            <code class="ruby">          fill_livestream_response(tx, livestream_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="354">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="355">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="356">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="357">
            <span class="hits">76</span>
            

            

            <code class="ruby">      json(livestreams)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="358">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="359">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="360">
            
            

            

            <code class="ruby">    get &#39;/api/user/:username/livestream&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="361">
            
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="362">
            
            

            

            <code class="ruby">      username = params[:username]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="363">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="364">
            
            

            

            <code class="ruby">      livestreams = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="365">
            
            

            

            <code class="ruby">        user = tx.xquery(&#39;SELECT * FROM users WHERE name = ?&#39;, username).first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="366">
            
            

            

            <code class="ruby">        unless user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="367">
            
            

            

            <code class="ruby">          raise HttpError.new(404, &#39;user not found&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="368">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="369">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="370">
            
            

            

            <code class="ruby">        tx.xquery(&#39;SELECT * FROM livestreams WHERE user_id = ?&#39;, user.fetch(:id)).map do |livestream_model|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="371">
            
            

            

            <code class="ruby">          fill_livestream_response(tx, livestream_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="372">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="373">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="374">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="375">
            
            

            

            <code class="ruby">      json(livestreams)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="376">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="377">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="378">
            
            

            

            <code class="ruby">    # ユーザ視聴開始 (viewer)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="379">
            
            

            

            <code class="ruby">    post &#39;/api/livestream/:livestream_id/enter&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="380">
            <span class="hits">19</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="381">
            <span class="hits">19</span>
            

            

            <code class="ruby">      sess = session[DEFAULT_SESSION_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="382">
            <span class="hits">19</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="383">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="384">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="385">
            <span class="hits">19</span>
            

            

            <code class="ruby">      user_id = sess[DEFAULT_USER_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="386">
            <span class="hits">19</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="387">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="388">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="389">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="390">
            <span class="hits">19</span>
            

            

            <code class="ruby">      livestream_id = cast_as_integer(params[:livestream_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="391">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="392">
            <span class="hits">19</span>
            

            

            <code class="ruby">      db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="393">
            <span class="hits">19</span>
            

            

            <code class="ruby">        created_at = Time.now.to_i</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="394">
            <span class="hits">19</span>
            

            

            <code class="ruby">        tx.xquery(&#39;INSERT INTO livestream_viewers_history (user_id, livestream_id, created_at) VALUES(?, ?, ?)&#39;, user_id, livestream_id, created_at)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="395">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="396">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="397">
            <span class="hits">19</span>
            

            

            <code class="ruby">      &#39;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="398">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="399">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="400">
            
            

            

            <code class="ruby">    # ユーザ視聴終了 (viewer)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="401">
            
            

            

            <code class="ruby">    delete &#39;/api/livestream/:livestream_id/exit&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="402">
            <span class="hits">9</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="403">
            <span class="hits">9</span>
            

            

            <code class="ruby">      sess = session[DEFAULT_SESSION_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="404">
            <span class="hits">9</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="405">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="406">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="407">
            <span class="hits">9</span>
            

            

            <code class="ruby">      user_id = sess[DEFAULT_USER_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="408">
            <span class="hits">9</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="409">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="410">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="411">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="412">
            <span class="hits">9</span>
            

            

            <code class="ruby">      livestream_id = cast_as_integer(params[:livestream_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="413">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="414">
            <span class="hits">9</span>
            

            

            <code class="ruby">      db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="415">
            <span class="hits">9</span>
            

            

            <code class="ruby">        tx.xquery(&#39;DELETE FROM livestream_viewers_history WHERE user_id = ? AND livestream_id = ?&#39;, user_id, livestream_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="416">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="417">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="418">
            <span class="hits">9</span>
            

            

            <code class="ruby">      &#39;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="419">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="420">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="421">
            
            

            

            <code class="ruby">    # get livestream</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="422">
            
            

            

            <code class="ruby">    get &#39;/api/livestream/:livestream_id&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="423">
            <span class="hits">1</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="424">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="425">
            <span class="hits">1</span>
            

            

            <code class="ruby">      livestream_id = cast_as_integer(params[:livestream_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="426">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="427">
            <span class="hits">1</span>
            

            

            <code class="ruby">      livestream = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="428">
            <span class="hits">1</span>
            

            

            <code class="ruby">        livestream_model = tx.xquery(&#39;SELECT * FROM livestreams WHERE id = ?&#39;, livestream_id).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="429">
            <span class="hits">1</span>
            

            

            <code class="ruby">        unless livestream_model</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="430">
            
            

            

            <code class="ruby">          raise HttpError.new(404)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="431">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="432">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="433">
            <span class="hits">1</span>
            

            

            <code class="ruby">        fill_livestream_response(tx, livestream_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="434">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="435">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="436">
            <span class="hits">1</span>
            

            

            <code class="ruby">      json(livestream)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="437">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="438">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="439">
            
            

            

            <code class="ruby">    # (配信者向け)ライブコメントの報告一覧取得API</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="440">
            
            

            

            <code class="ruby">    get &#39;/api/livestream/:livestream_id/report&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="441">
            <span class="hits">21</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="442">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="443">
            <span class="hits">21</span>
            

            

            <code class="ruby">      sess = session[DEFAULT_SESSION_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="444">
            <span class="hits">21</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="445">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="446">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="447">
            <span class="hits">21</span>
            

            

            <code class="ruby">      user_id = sess[DEFAULT_USER_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="448">
            <span class="hits">21</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="449">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="450">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="451">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="452">
            <span class="hits">21</span>
            

            

            <code class="ruby">      livestream_id = cast_as_integer(params[:livestream_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="453">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="454">
            <span class="hits">21</span>
            

            

            <code class="ruby">      reports = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="455">
            <span class="hits">21</span>
            

            

            <code class="ruby">        livestream_model = tx.xquery(&#39;SELECT * FROM livestreams WHERE id = ?&#39;, livestream_id).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="456">
            <span class="hits">21</span>
            

            

            <code class="ruby">        if livestream_model.fetch(:user_id) != user_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="457">
            
            

            

            <code class="ruby">          raise HttpError.new(403, &quot;can&#39;t get other streamer&#39;s livecomment reports&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="458">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="459">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="460">
            <span class="hits">21</span>
            

            

            <code class="ruby">        tx.xquery(&#39;SELECT * FROM livecomment_reports WHERE livestream_id = ?&#39;, livestream_id).map do |report_model|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="461">
            <span class="hits">20</span>
            

            

            <code class="ruby">          fill_livecomment_report_response(tx, report_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="462">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="463">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="464">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="465">
            <span class="hits">21</span>
            

            

            <code class="ruby">      json(reports)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="466">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="467">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="468">
            
            

            

            <code class="ruby">    # get polling livecomment timeline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="469">
            
            

            

            <code class="ruby">    get &#39;/api/livestream/:livestream_id/livecomment&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="160" data-linenumber="470">
            <span class="hits">160</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="160" data-linenumber="471">
            <span class="hits">160</span>
            

            

            <code class="ruby">      livestream_id = cast_as_integer(params[:livestream_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="472">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="160" data-linenumber="473">
            <span class="hits">160</span>
            

            

            <code class="ruby">      livecomments = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="160" data-linenumber="474">
            <span class="hits">160</span>
            

            

            <code class="ruby">        query = &#39;SELECT * FROM livecomments WHERE livestream_id = ? ORDER BY created_at DESC&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="160" data-linenumber="475">
            <span class="hits">160</span>
            

            

            <code class="ruby">        limit_str = params[:limit] || &#39;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="160" data-linenumber="476">
            <span class="hits">160</span>
            

            

            <code class="ruby">        if limit_str != &#39;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="477">
            <span class="hits">18</span>
            

            

            <code class="ruby">          limit = cast_as_integer(limit_str)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="478">
            <span class="hits">18</span>
            

            

            <code class="ruby">          query = &quot;#{query} LIMIT #{limit}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="479">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="480">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="160" data-linenumber="481">
            <span class="hits">160</span>
            

            

            <code class="ruby">        tx.xquery(query, livestream_id).map do |livecomment_model|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="864" data-linenumber="482">
            <span class="hits">864</span>
            

            

            <code class="ruby">          fill_livecomment_response(tx, livecomment_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="483">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="484">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="485">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="160" data-linenumber="486">
            <span class="hits">160</span>
            

            

            <code class="ruby">      json(livecomments)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="487">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="488">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="489">
            
            

            

            <code class="ruby">    get &#39;/api/livestream/:livestream_id/ngwords&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="490">
            <span class="hits">15</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="491">
            <span class="hits">15</span>
            

            

            <code class="ruby">      sess = session[DEFAULT_SESSION_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="492">
            <span class="hits">15</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="493">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="494">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="495">
            <span class="hits">15</span>
            

            

            <code class="ruby">      user_id = sess[DEFAULT_USER_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="496">
            <span class="hits">15</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="497">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="498">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="499">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="500">
            <span class="hits">15</span>
            

            

            <code class="ruby">      livestream_id = cast_as_integer(params[:livestream_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="501">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="502">
            <span class="hits">15</span>
            

            

            <code class="ruby">      ng_words = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="503">
            <span class="hits">15</span>
            

            

            <code class="ruby">        tx.xquery(&#39;SELECT * FROM ng_words WHERE user_id = ? AND livestream_id = ? ORDER BY created_at DESC&#39;, user_id, livestream_id).to_a</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="504">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="505">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="506">
            <span class="hits">15</span>
            

            

            <code class="ruby">      json(ng_words)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="507">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="508">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="509">
            
            

            

            <code class="ruby">    PostLivecommentRequest = Data.define(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="510">
            
            

            

            <code class="ruby">      :comment,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="511">
            
            

            

            <code class="ruby">      :tip,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="512">
            
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="513">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="514">
            
            

            

            <code class="ruby">    # ライブコメント投稿</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="515">
            
            

            

            <code class="ruby">    post &#39;/api/livestream/:livestream_id/livecomment&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="171" data-linenumber="516">
            <span class="hits">171</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="171" data-linenumber="517">
            <span class="hits">171</span>
            

            

            <code class="ruby">      sess = session[DEFAULT_SESSION_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="171" data-linenumber="518">
            <span class="hits">171</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="519">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="520">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="171" data-linenumber="521">
            <span class="hits">171</span>
            

            

            <code class="ruby">      user_id = sess[DEFAULT_USER_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="171" data-linenumber="522">
            <span class="hits">171</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="523">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="524">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="525">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="171" data-linenumber="526">
            <span class="hits">171</span>
            

            

            <code class="ruby">      livestream_id = cast_as_integer(params[:livestream_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="527">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="171" data-linenumber="528">
            <span class="hits">171</span>
            

            

            <code class="ruby">      req = decode_request_body(PostLivecommentRequest)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="529">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="171" data-linenumber="530">
            <span class="hits">171</span>
            

            

            <code class="ruby">      livecomment = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="171" data-linenumber="531">
            <span class="hits">171</span>
            

            

            <code class="ruby">        livestream_model = tx.xquery(&#39;SELECT * FROM livestreams WHERE id = ?&#39;, livestream_id).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="171" data-linenumber="532">
            <span class="hits">171</span>
            

            

            <code class="ruby">        unless livestream_model</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="533">
            
            

            

            <code class="ruby">          raise HttpError.new(404, &#39;livestream not found&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="534">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="535">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="536">
            
            

            

            <code class="ruby">        # スパム判定</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="171" data-linenumber="537">
            <span class="hits">171</span>
            

            

            <code class="ruby">        tx.xquery(&#39;SELECT id, user_id, livestream_id, word FROM ng_words WHERE user_id = ? AND livestream_id = ?&#39;, livestream_model.fetch(:user_id), livestream_model.fetch(:id)).each do |ng_word|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="33" data-linenumber="538">
            <span class="hits">33</span>
            

            

            <code class="ruby">          query = &lt;&lt;~SQL</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="539">
            
            

            

            <code class="ruby">            SELECT COUNT(*)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="540">
            
            

            

            <code class="ruby">            FROM</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="541">
            
            

            

            <code class="ruby">            (SELECT ? AS text) AS texts</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="542">
            
            

            

            <code class="ruby">            INNER JOIN</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="543">
            
            

            

            <code class="ruby">            (SELECT CONCAT(&#39;%&#39;, ?, &#39;%&#39;)	AS pattern) AS patterns</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="544">
            
            

            

            <code class="ruby">            ON texts.text LIKE patterns.pattern</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="545">
            
            

            

            <code class="ruby">          SQL</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="33" data-linenumber="546">
            <span class="hits">33</span>
            

            

            <code class="ruby">          hit_spam = tx.xquery(query, req.comment, ng_word.fetch(:word), as: :array).first[0]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="33" data-linenumber="547">
            <span class="hits">33</span>
            

            

            <code class="ruby">          logger.info(&quot;[hit_spam=#{hit_spam}] comment = #{req.comment}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="33" data-linenumber="548">
            <span class="hits">33</span>
            

            

            <code class="ruby">          if hit_spam &gt;= 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="549">
            <span class="hits">1</span>
            

            

            <code class="ruby">            raise HttpError.new(400, &#39;このコメントがスパム判定されました&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="550">
            
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="551">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="552">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="170" data-linenumber="553">
            <span class="hits">170</span>
            

            

            <code class="ruby">        now = Time.now.to_i</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="170" data-linenumber="554">
            <span class="hits">170</span>
            

            

            <code class="ruby">        tx.xquery(&#39;INSERT INTO livecomments (user_id, livestream_id, comment, tip, created_at) VALUES (?, ?, ?, ?, ?)&#39;, user_id, livestream_id, req.comment, req.tip, now)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="170" data-linenumber="555">
            <span class="hits">170</span>
            

            

            <code class="ruby">        livecomment_id = tx.last_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="556">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="170" data-linenumber="557">
            <span class="hits">170</span>
            

            

            <code class="ruby">        fill_livecomment_response(tx, {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="558">
            
            

            

            <code class="ruby">          id: livecomment_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="559">
            
            

            

            <code class="ruby">          user_id:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="560">
            
            

            

            <code class="ruby">          livestream_id:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="561">
            
            

            

            <code class="ruby">          comment: req.comment,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="562">
            
            

            

            <code class="ruby">          tip: req.tip,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="563">
            
            

            

            <code class="ruby">          created_at: now,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="564">
            
            

            

            <code class="ruby">        })</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="565">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="566">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="170" data-linenumber="567">
            <span class="hits">170</span>
            

            

            <code class="ruby">      status 201</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="170" data-linenumber="568">
            <span class="hits">170</span>
            

            

            <code class="ruby">      json(livecomment)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="569">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="570">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="571">
            
            

            

            <code class="ruby">    # ライブコメント報告</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="572">
            
            

            

            <code class="ruby">    post &#39;/api/livestream/:livestream_id/livecomment/:livecomment_id/report&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="573">
            <span class="hits">48</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="574">
            <span class="hits">48</span>
            

            

            <code class="ruby">      sess = session[DEFAULT_SESSION_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="575">
            <span class="hits">48</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="576">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="577">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="578">
            <span class="hits">48</span>
            

            

            <code class="ruby">      user_id = sess[DEFAULT_USER_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="579">
            <span class="hits">48</span>
            

            

            <code class="ruby">      unless user_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="580">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="581">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="582">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="583">
            <span class="hits">48</span>
            

            

            <code class="ruby">      livestream_id = cast_as_integer(params[:livestream_id])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="584">
            <span class="hits">48</span>
            

            

            <code class="ruby">      livecomment_id = cast_as_integer(params[:livecomment_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="585">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="586">
            <span class="hits">48</span>
            

            

            <code class="ruby">      report = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="587">
            <span class="hits">48</span>
            

            

            <code class="ruby">        livestream_model = tx.xquery(&#39;SELECT * FROM livestreams WHERE id = ?&#39;, livestream_id).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="588">
            <span class="hits">48</span>
            

            

            <code class="ruby">        unless livestream_model</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="589">
            
            

            

            <code class="ruby">          raise HttpError.new(404, &#39;livestream not found&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="590">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="591">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="592">
            <span class="hits">48</span>
            

            

            <code class="ruby">        livecomment_model = tx.xquery(&#39;SELECT * FROM livecomments WHERE id = ?&#39;, livecomment_id).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="48" data-linenumber="593">
            <span class="hits">48</span>
            

            

            <code class="ruby">        unless livecomment_model</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="594">
            <span class="hits">6</span>
            

            

            <code class="ruby">          raise HttpError.new(404, &#39;livecomment not found&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="595">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="596">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="42" data-linenumber="597">
            <span class="hits">42</span>
            

            

            <code class="ruby">        now = Time.now.to_i</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="42" data-linenumber="598">
            <span class="hits">42</span>
            

            

            <code class="ruby">        tx.xquery(&#39;INSERT INTO livecomment_reports(user_id, livestream_id, livecomment_id, created_at) VALUES (?, ?, ?, ?)&#39;, user_id, livestream_id, livecomment_id, now)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="42" data-linenumber="599">
            <span class="hits">42</span>
            

            

            <code class="ruby">        report_id = tx.last_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="600">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="42" data-linenumber="601">
            <span class="hits">42</span>
            

            

            <code class="ruby">        fill_livecomment_report_response(tx, {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="602">
            
            

            

            <code class="ruby">          id: report_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="603">
            
            

            

            <code class="ruby">          user_id:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="604">
            
            

            

            <code class="ruby">          livestream_id:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="605">
            
            

            

            <code class="ruby">          livecomment_id:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="606">
            
            

            

            <code class="ruby">          created_at: now,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="607">
            
            

            

            <code class="ruby">        })</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="608">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="609">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="42" data-linenumber="610">
            <span class="hits">42</span>
            

            

            <code class="ruby">      status 201</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="42" data-linenumber="611">
            <span class="hits">42</span>
            

            

            <code class="ruby">      json(report)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="612">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="613">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="614">
            
            

            

            <code class="ruby">    ModerateRequest = Data.define(:ng_word)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="615">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="616">
            
            

            

            <code class="ruby">    # 配信者によるモデレーション (NGワード登録)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="617">
            
            

            

            <code class="ruby">    post &#39;/api/livestream/:livestream_id/moderate&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="618">
            <span class="hits">13</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="619">
            <span class="hits">13</span>
            

            

            <code class="ruby">      sess = session[DEFAULT_SESSION_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="620">
            <span class="hits">13</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="621">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="622">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="623">
            <span class="hits">13</span>
            

            

            <code class="ruby">      user_id = sess[DEFAULT_USER_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="624">
            <span class="hits">13</span>
            

            

            <code class="ruby">      unless user_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="625">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="626">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="627">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="628">
            <span class="hits">13</span>
            

            

            <code class="ruby">      livestream_id = cast_as_integer(params[:livestream_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="629">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="630">
            <span class="hits">13</span>
            

            

            <code class="ruby">      req = decode_request_body(ModerateRequest)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="631">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="632">
            <span class="hits">13</span>
            

            

            <code class="ruby">      word_id = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="633">
            
            

            

            <code class="ruby">        # 配信者自身の配信に対するmoderateなのかを検証</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="634">
            <span class="hits">13</span>
            

            

            <code class="ruby">        owned_livestreams = tx.xquery(&#39;SELECT * FROM livestreams WHERE id = ? AND user_id = ?&#39;, livestream_id, user_id).to_a</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="635">
            <span class="hits">13</span>
            

            

            <code class="ruby">        if owned_livestreams.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="636">
            
            

            

            <code class="ruby">          raise HttpError.new(400, &quot;A streamer can&#39;t moderate livestreams that other streamers own&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="637">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="638">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="639">
            <span class="hits">13</span>
            

            

            <code class="ruby">        tx.xquery(&#39;INSERT INTO ng_words(user_id, livestream_id, word, created_at) VALUES (?, ?, ?, ?)&#39;, user_id, livestream_id, req.ng_word, Time.now.to_i)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="640">
            <span class="hits">13</span>
            

            

            <code class="ruby">        word_id = tx.last_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="641">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="642">
            
            

            

            <code class="ruby">        # NGワードにヒットする過去の投稿も全削除する</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="643">
            <span class="hits">13</span>
            

            

            <code class="ruby">        tx.xquery(&#39;SELECT * FROM ng_words WHERE livestream_id = ?&#39;, livestream_id).each do |ng_word|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="644">
            
            

            

            <code class="ruby">          # ライブコメント一覧取得</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="645">
            <span class="hits">14</span>
            

            

            <code class="ruby">          tx.xquery(&#39;SELECT * FROM livecomments&#39;).each do |livecomment|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15411" data-linenumber="646">
            <span class="hits">15411</span>
            

            

            <code class="ruby">            query = &lt;&lt;~SQL</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="647">
            
            

            

            <code class="ruby">              DELETE FROM livecomments</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="648">
            
            

            

            <code class="ruby">              WHERE</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="649">
            
            

            

            <code class="ruby">              id = ? AND</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="650">
            
            

            

            <code class="ruby">              livestream_id = ? AND</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="651">
            
            

            

            <code class="ruby">              (SELECT COUNT(*)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="652">
            
            

            

            <code class="ruby">              FROM</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="653">
            
            

            

            <code class="ruby">              (SELECT ? AS text) AS texts</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="654">
            
            

            

            <code class="ruby">              INNER JOIN</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="655">
            
            

            

            <code class="ruby">              (SELECT CONCAT(&#39;%&#39;, ?, &#39;%&#39;)	AS pattern) AS patterns</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="656">
            
            

            

            <code class="ruby">              ON texts.text LIKE patterns.pattern) &gt;= 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="657">
            
            

            

            <code class="ruby">            SQL</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15411" data-linenumber="658">
            <span class="hits">15411</span>
            

            

            <code class="ruby">            tx.xquery(query, livecomment.fetch(:id), livestream_id, livecomment.fetch(:comment), ng_word.fetch(:word))</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="659">
            
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="660">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="661">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="662">
            <span class="hits">13</span>
            

            

            <code class="ruby">        word_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="663">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="664">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="665">
            <span class="hits">13</span>
            

            

            <code class="ruby">      status 201</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="666">
            <span class="hits">13</span>
            

            

            <code class="ruby">      json(word_id:)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="667">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="668">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="669">
            
            

            

            <code class="ruby">    get &#39;/api/livestream/:livestream_id/reaction&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="191" data-linenumber="670">
            <span class="hits">191</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="671">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="191" data-linenumber="672">
            <span class="hits">191</span>
            

            

            <code class="ruby">      livestream_id = cast_as_integer(params[:livestream_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="673">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="191" data-linenumber="674">
            <span class="hits">191</span>
            

            

            <code class="ruby">      reactions = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="191" data-linenumber="675">
            <span class="hits">191</span>
            

            

            <code class="ruby">        query = &#39;SELECT * FROM reactions WHERE livestream_id = ? ORDER BY created_at DESC&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="191" data-linenumber="676">
            <span class="hits">191</span>
            

            

            <code class="ruby">        limit_str = params[:limit] || &#39;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="191" data-linenumber="677">
            <span class="hits">191</span>
            

            

            <code class="ruby">        if limit_str != &#39;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="678">
            <span class="hits">17</span>
            

            

            <code class="ruby">          limit = cast_as_integer(limit_str)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="679">
            <span class="hits">17</span>
            

            

            <code class="ruby">          query = &quot;#{query} LIMIT #{limit}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="680">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="681">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="191" data-linenumber="682">
            <span class="hits">191</span>
            

            

            <code class="ruby">        tx.xquery(query, livestream_id).map do |reaction_model|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="709" data-linenumber="683">
            <span class="hits">709</span>
            

            

            <code class="ruby">          fill_reaction_response(tx, reaction_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="684">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="685">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="686">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="191" data-linenumber="687">
            <span class="hits">191</span>
            

            

            <code class="ruby">      json(reactions)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="688">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="689">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="690">
            
            

            

            <code class="ruby">    PostReactionRequest = Data.define(:emoji_name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="691">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="692">
            
            

            

            <code class="ruby">    post &#39;/api/livestream/:livestream_id/reaction&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="154" data-linenumber="693">
            <span class="hits">154</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="154" data-linenumber="694">
            <span class="hits">154</span>
            

            

            <code class="ruby">      sess = session[DEFAULT_SESSION_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="154" data-linenumber="695">
            <span class="hits">154</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="696">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="697">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="154" data-linenumber="698">
            <span class="hits">154</span>
            

            

            <code class="ruby">      user_id = sess[DEFAULT_USER_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="154" data-linenumber="699">
            <span class="hits">154</span>
            

            

            <code class="ruby">      unless user_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="700">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="701">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="702">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="154" data-linenumber="703">
            <span class="hits">154</span>
            

            

            <code class="ruby">      livestream_id = Integer(params[:livestream_id], 10)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="704">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="154" data-linenumber="705">
            <span class="hits">154</span>
            

            

            <code class="ruby">      req = decode_request_body(PostReactionRequest)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="706">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="154" data-linenumber="707">
            <span class="hits">154</span>
            

            

            <code class="ruby">      reaction = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="154" data-linenumber="708">
            <span class="hits">154</span>
            

            

            <code class="ruby">        created_at = Time.now.to_i</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="154" data-linenumber="709">
            <span class="hits">154</span>
            

            

            <code class="ruby">        tx.xquery(&#39;INSERT INTO reactions (user_id, livestream_id, emoji_name, created_at) VALUES (?, ?, ?, ?)&#39;, user_id, livestream_id, req.emoji_name, created_at)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="154" data-linenumber="710">
            <span class="hits">154</span>
            

            

            <code class="ruby">        reaction_id = tx.last_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="711">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="154" data-linenumber="712">
            <span class="hits">154</span>
            

            

            <code class="ruby">        fill_reaction_response(tx, {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="713">
            
            

            

            <code class="ruby">          id: reaction_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="714">
            
            

            

            <code class="ruby">          user_id:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="715">
            
            

            

            <code class="ruby">          livestream_id:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="716">
            
            

            

            <code class="ruby">          emoji_name: req.emoji_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="717">
            
            

            

            <code class="ruby">          created_at:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="718">
            
            

            

            <code class="ruby">        })</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="719">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="720">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="154" data-linenumber="721">
            <span class="hits">154</span>
            

            

            <code class="ruby">      status 201</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="154" data-linenumber="722">
            <span class="hits">154</span>
            

            

            <code class="ruby">      json(reaction)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="723">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="724">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="725">
            
            

            

            <code class="ruby">    BCRYPT_DEFAULT_COST = 4</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="726">
            
            

            

            <code class="ruby">    FALLBACK_IMAGE = &#39;../img/NoImage.jpg&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="727">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="728">
            
            

            

            <code class="ruby">    get &#39;/api/user/:username/icon&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1437" data-linenumber="729">
            <span class="hits">1437</span>
            

            

            <code class="ruby">      username = params[:username]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="730">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1437" data-linenumber="731">
            <span class="hits">1437</span>
            

            

            <code class="ruby">      image = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1437" data-linenumber="732">
            <span class="hits">1437</span>
            

            

            <code class="ruby">        user = tx.xquery(&#39;SELECT * FROM users WHERE name = ?&#39;, username).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1437" data-linenumber="733">
            <span class="hits">1437</span>
            

            

            <code class="ruby">        unless user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="734">
            
            

            

            <code class="ruby">          raise HttpError.new(404, &#39;not found user that has the given username&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="735">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1437" data-linenumber="736">
            <span class="hits">1437</span>
            

            

            <code class="ruby">        tx.xquery(&#39;SELECT image FROM icons WHERE user_id = ?&#39;, user.fetch(:id)).first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="737">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="738">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1437" data-linenumber="739">
            <span class="hits">1437</span>
            

            

            <code class="ruby">      content_type &#39;image/jpeg&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1437" data-linenumber="740">
            <span class="hits">1437</span>
            

            

            <code class="ruby">      if image</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="920" data-linenumber="741">
            <span class="hits">920</span>
            

            

            <code class="ruby">        image[:image]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="742">
            
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="517" data-linenumber="743">
            <span class="hits">517</span>
            

            

            <code class="ruby">        send_file FALLBACK_IMAGE</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="744">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="745">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="746">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="747">
            
            

            

            <code class="ruby">    PostIconRequest = Data.define(:image)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="748">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="749">
            
            

            

            <code class="ruby">    post &#39;/api/icon&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="431" data-linenumber="750">
            <span class="hits">431</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="751">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="431" data-linenumber="752">
            <span class="hits">431</span>
            

            

            <code class="ruby">      sess = session[DEFAULT_SESSION_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="431" data-linenumber="753">
            <span class="hits">431</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="754">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="755">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="431" data-linenumber="756">
            <span class="hits">431</span>
            

            

            <code class="ruby">      user_id = sess[DEFAULT_USER_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="431" data-linenumber="757">
            <span class="hits">431</span>
            

            

            <code class="ruby">      unless user_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="758">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="759">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="760">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="431" data-linenumber="761">
            <span class="hits">431</span>
            

            

            <code class="ruby">      req = decode_request_body(PostIconRequest)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="431" data-linenumber="762">
            <span class="hits">431</span>
            

            

            <code class="ruby">      image = Base64.decode64(req.image)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="763">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="431" data-linenumber="764">
            <span class="hits">431</span>
            

            

            <code class="ruby">      icon_id = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="431" data-linenumber="765">
            <span class="hits">431</span>
            

            

            <code class="ruby">        tx.xquery(&#39;DELETE FROM icons WHERE user_id = ?&#39;, user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="431" data-linenumber="766">
            <span class="hits">431</span>
            

            

            <code class="ruby">        tx.xquery(&#39;INSERT INTO icons (user_id, image) VALUES (?, ?)&#39;, user_id, image)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="431" data-linenumber="767">
            <span class="hits">431</span>
            

            

            <code class="ruby">        tx.last_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="768">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="769">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="431" data-linenumber="770">
            <span class="hits">431</span>
            

            

            <code class="ruby">      status 201</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="431" data-linenumber="771">
            <span class="hits">431</span>
            

            

            <code class="ruby">      json(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="772">
            
            

            

            <code class="ruby">        id: icon_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="773">
            
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="774">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="775">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="776">
            
            

            

            <code class="ruby">    get &#39;/api/user/me&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="777">
            <span class="hits">3</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="778">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="779">
            <span class="hits">3</span>
            

            

            <code class="ruby">      sess = session[DEFAULT_SESSION_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="780">
            <span class="hits">3</span>
            

            

            <code class="ruby">      unless sess</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="781">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="782">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="783">
            <span class="hits">3</span>
            

            

            <code class="ruby">      user_id = sess[DEFAULT_USER_ID_KEY]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="784">
            <span class="hits">3</span>
            

            

            <code class="ruby">      unless user_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="785">
            
            

            

            <code class="ruby">        raise HttpError.new(401)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="786">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="787">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="788">
            <span class="hits">3</span>
            

            

            <code class="ruby">      user = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="789">
            <span class="hits">3</span>
            

            

            <code class="ruby">        user_model = tx.xquery(&#39;SELECT * FROM users WHERE id = ?&#39;, user_id).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="790">
            <span class="hits">3</span>
            

            

            <code class="ruby">        unless user_model</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="791">
            
            

            

            <code class="ruby">          raise HttpError.new(404)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="792">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="793">
            <span class="hits">3</span>
            

            

            <code class="ruby">        fill_user_response(tx, user_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="794">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="795">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="796">
            <span class="hits">3</span>
            

            

            <code class="ruby">      json(user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="797">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="798">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="799">
            
            

            

            <code class="ruby">    PostUserRequest = Data.define(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="800">
            
            

            

            <code class="ruby">      :name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="801">
            
            

            

            <code class="ruby">      :display_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="802">
            
            

            

            <code class="ruby">      :description,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="803">
            
            

            

            <code class="ruby">      # password is non-hashed password.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="804">
            
            

            

            <code class="ruby">      :password,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="805">
            
            

            

            <code class="ruby">      :theme,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="806">
            
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="807">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="808">
            
            

            

            <code class="ruby">    # ユーザ登録API</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="809">
            
            

            

            <code class="ruby">    post &#39;/api/register&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="435" data-linenumber="810">
            <span class="hits">435</span>
            

            

            <code class="ruby">      req = decode_request_body(PostUserRequest)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="435" data-linenumber="811">
            <span class="hits">435</span>
            

            

            <code class="ruby">      if req.name == &#39;pipe&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="812">
            <span class="hits">1</span>
            

            

            <code class="ruby">        raise HttpError.new(400, &quot;the username &#39;pipe&#39; is reserved&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="813">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="814">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="434" data-linenumber="815">
            <span class="hits">434</span>
            

            

            <code class="ruby">      hashed_password = BCrypt::Password.create(req.password, cost: BCRYPT_DEFAULT_COST)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="816">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="434" data-linenumber="817">
            <span class="hits">434</span>
            

            

            <code class="ruby">      user = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="434" data-linenumber="818">
            <span class="hits">434</span>
            

            

            <code class="ruby">        tx.xquery(&#39;INSERT INTO users (name, display_name, description, password) VALUES(?, ?, ?, ?)&#39;, req.name, req.display_name, req.description, hashed_password)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="433" data-linenumber="819">
            <span class="hits">433</span>
            

            

            <code class="ruby">        user_id = tx.last_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="820">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="433" data-linenumber="821">
            <span class="hits">433</span>
            

            

            <code class="ruby">        tx.xquery(&#39;INSERT INTO themes (user_id, dark_mode) VALUES(?, ?)&#39;, user_id, req.theme.fetch(:dark_mode))</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="822">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="433" data-linenumber="823">
            <span class="hits">433</span>
            

            

            <code class="ruby">        out, status = Open3.capture2e(&#39;pdnsutil&#39;, &#39;add-record&#39;, &#39;u.isucon.dev&#39;, req.name, &#39;A&#39;, &#39;0&#39;, POWERDNS_SUBDOMAIN_ADDRESS)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="433" data-linenumber="824">
            <span class="hits">433</span>
            

            

            <code class="ruby">        unless status.success?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="825">
            
            

            

            <code class="ruby">          raise HttpError.new(500, &quot;pdnsutil failed with out=#{out}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="826">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="827">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="433" data-linenumber="828">
            <span class="hits">433</span>
            

            

            <code class="ruby">        fill_user_response(tx, {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="829">
            
            

            

            <code class="ruby">          id: user_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="830">
            
            

            

            <code class="ruby">          name: req.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="831">
            
            

            

            <code class="ruby">          display_name: req.display_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="832">
            
            

            

            <code class="ruby">          description: req.description,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="833">
            
            

            

            <code class="ruby">        })</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="834">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="835">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="433" data-linenumber="836">
            <span class="hits">433</span>
            

            

            <code class="ruby">      status 201</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="433" data-linenumber="837">
            <span class="hits">433</span>
            

            

            <code class="ruby">      json(user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="838">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="839">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="840">
            
            

            

            <code class="ruby">    LoginRequest = Data.define(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="841">
            
            

            

            <code class="ruby">      :username,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="842">
            
            

            

            <code class="ruby">      # password is non-hashed password.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="843">
            
            

            

            <code class="ruby">      :password,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="844">
            
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="845">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="846">
            
            

            

            <code class="ruby">    # ユーザログインAPI</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="847">
            
            

            

            <code class="ruby">    post &#39;/api/login&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="439" data-linenumber="848">
            <span class="hits">439</span>
            

            

            <code class="ruby">      req = decode_request_body(LoginRequest)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="849">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="439" data-linenumber="850">
            <span class="hits">439</span>
            

            

            <code class="ruby">      user_model = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="851">
            
            

            

            <code class="ruby">        # usernameはUNIQUEなので、whereで一意に特定できる</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="439" data-linenumber="852">
            <span class="hits">439</span>
            

            

            <code class="ruby">        tx.xquery(&#39;SELECT * FROM users WHERE name = ?&#39;, req.username).first.tap do |user_model|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="439" data-linenumber="853">
            <span class="hits">439</span>
            

            

            <code class="ruby">          unless user_model</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="854">
            <span class="hits">1</span>
            

            

            <code class="ruby">            raise HttpError.new(401, &#39;invalid username or password&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="855">
            
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="856">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="857">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="858">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="438" data-linenumber="859">
            <span class="hits">438</span>
            

            

            <code class="ruby">      unless BCrypt::Password.new(user_model.fetch(:password)).is_password?(req.password)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="860">
            <span class="hits">1</span>
            

            

            <code class="ruby">        raise HttpError.new(401, &#39;invalid username or password&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="861">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="862">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="437" data-linenumber="863">
            <span class="hits">437</span>
            

            

            <code class="ruby">      session_end_at = Time.now + 10*60*60</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="437" data-linenumber="864">
            <span class="hits">437</span>
            

            

            <code class="ruby">      session_id = SecureRandom.uuid</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="437" data-linenumber="865">
            <span class="hits">437</span>
            

            

            <code class="ruby">      session[DEFAULT_SESSION_ID_KEY] = {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="866">
            
            

            

            <code class="ruby">        DEFAULT_SESSION_ID_KEY =&gt; session_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="867">
            
            

            

            <code class="ruby">        DEFAULT_USER_ID_KEY =&gt; user_model.fetch(:id),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="868">
            
            

            

            <code class="ruby">        DEFAULT_USERNAME_KEY =&gt; user_model.fetch(:name),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="869">
            
            

            

            <code class="ruby">        DEFAULT_SESSION_EXPIRES_KEY =&gt; session_end_at.to_i,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="870">
            
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="871">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="437" data-linenumber="872">
            <span class="hits">437</span>
            

            

            <code class="ruby">      &#39;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="873">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="874">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="875">
            
            

            

            <code class="ruby">    # ユーザ詳細API</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="876">
            
            

            

            <code class="ruby">    get &#39;/api/user/:username&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="877">
            <span class="hits">1</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="878">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="879">
            <span class="hits">1</span>
            

            

            <code class="ruby">      username = params[:username]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="880">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="881">
            <span class="hits">1</span>
            

            

            <code class="ruby">      user = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="882">
            <span class="hits">1</span>
            

            

            <code class="ruby">        user_model = tx.xquery(&#39;SELECT * FROM users WHERE name = ?&#39;, username).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="883">
            <span class="hits">1</span>
            

            

            <code class="ruby">        unless user_model</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="884">
            
            

            

            <code class="ruby">          raise HttpError.new(404)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="885">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="886">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="887">
            <span class="hits">1</span>
            

            

            <code class="ruby">        fill_user_response(tx, user_model)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="888">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="889">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="890">
            <span class="hits">1</span>
            

            

            <code class="ruby">      json(user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="891">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="892">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="893">
            
            

            

            <code class="ruby">    UserRankingEntry = Data.define(:username, :score)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="894">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="895">
            
            

            

            <code class="ruby">    get &#39;/api/user/:username/statistics&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="896">
            <span class="hits">6</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="897">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="898">
            <span class="hits">6</span>
            

            

            <code class="ruby">      username = params[:username]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="899">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="900">
            
            

            

            <code class="ruby">      # ユーザごとに、紐づく配信について、累計リアクション数、累計ライブコメント数、累計売上金額を算出</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="901">
            
            

            

            <code class="ruby">      # また、現在の合計視聴者数もだす</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="902">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="903">
            <span class="hits">6</span>
            

            

            <code class="ruby">      stats = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="904">
            <span class="hits">6</span>
            

            

            <code class="ruby">        user = tx.xquery(&#39;SELECT * FROM users WHERE name = ?&#39;, username).first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="905">
            <span class="hits">6</span>
            

            

            <code class="ruby">        unless user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="906">
            
            

            

            <code class="ruby">          raise HttpError.new(400)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="907">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="908">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="909">
            
            

            

            <code class="ruby">        # ランク算出</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="910">
            <span class="hits">6</span>
            

            

            <code class="ruby">        users = tx.xquery(&#39;SELECT * FROM users&#39;).to_a</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="911">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="912">
            <span class="hits">6</span>
            

            

            <code class="ruby">        ranking = users.map do |user|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3871" data-linenumber="913">
            <span class="hits">3871</span>
            

            

            <code class="ruby">          reactions = tx.xquery(&lt;&lt;~SQL, user.fetch(:id), as: :array).first[0]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="914">
            
            

            

            <code class="ruby">            SELECT COUNT(*) FROM users u</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="915">
            
            

            

            <code class="ruby">            INNER JOIN livestreams l ON l.user_id = u.id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="916">
            
            

            

            <code class="ruby">            INNER JOIN reactions r ON r.livestream_id = l.id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="917">
            
            

            

            <code class="ruby">            WHERE u.id = ?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="918">
            
            

            

            <code class="ruby">          SQL</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="919">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3871" data-linenumber="920">
            <span class="hits">3871</span>
            

            

            <code class="ruby">          tips = tx.xquery(&lt;&lt;~SQL, user.fetch(:id), as: :array).first[0]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="921">
            
            

            

            <code class="ruby">            SELECT IFNULL(SUM(l2.tip), 0) FROM users u</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="922">
            
            

            

            <code class="ruby">            INNER JOIN livestreams l ON l.user_id = u.id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="923">
            
            

            

            <code class="ruby">            INNER JOIN livecomments l2 ON l2.livestream_id = l.id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="924">
            
            

            

            <code class="ruby">            WHERE u.id = ?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="925">
            
            

            

            <code class="ruby">          SQL</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="926">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3867" data-linenumber="927">
            <span class="hits">3867</span>
            

            

            <code class="ruby">          score = reactions + tips</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3867" data-linenumber="928">
            <span class="hits">3867</span>
            

            

            <code class="ruby">          UserRankingEntry.new(username: user.fetch(:name), score:)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="929">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="930">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2002" data-linenumber="931">
            <span class="hits">2002</span>
            

            

            <code class="ruby">        ranking.sort_by! { |entry| [entry.score, entry.username] }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="754" data-linenumber="932">
            <span class="hits">754</span>
            

            

            <code class="ruby">        ridx = ranking.rindex { |entry| entry.username == username }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="933">
            <span class="hits">2</span>
            

            

            <code class="ruby">        rank = ranking.size - ridx</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="934">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="935">
            
            

            

            <code class="ruby">        # リアクション数</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="936">
            <span class="hits">2</span>
            

            

            <code class="ruby">        total_reactions = tx.xquery(&lt;&lt;~SQL, username, as: :array).first[0]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="937">
            
            

            

            <code class="ruby">          SELECT COUNT(*) FROM users u</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="938">
            
            

            

            <code class="ruby">          INNER JOIN livestreams l ON l.user_id = u.id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="939">
            
            

            

            <code class="ruby">          INNER JOIN reactions r ON r.livestream_id = l.id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="940">
            
            

            

            <code class="ruby">          WHERE u.name = ?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="941">
            
            

            

            <code class="ruby">        SQL</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="942">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="943">
            
            

            

            <code class="ruby">        # ライブコメント数、チップ合計</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="944">
            <span class="hits">2</span>
            

            

            <code class="ruby">        total_livecomments = 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="945">
            <span class="hits">2</span>
            

            

            <code class="ruby">        total_tip = 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="946">
            <span class="hits">2</span>
            

            

            <code class="ruby">        livestreams = tx.xquery(&#39;SELECT * FROM livestreams WHERE user_id = ?&#39;, user.fetch(:id))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="947">
            <span class="hits">2</span>
            

            

            <code class="ruby">        livestreams.each do |livestream|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="948">
            <span class="hits">18</span>
            

            

            <code class="ruby">          tx.xquery(&#39;SELECT * FROM livecomments WHERE livestream_id = ?&#39;, livestream.fetch(:id)).each do |livecomment|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="949">
            <span class="hits">4</span>
            

            

            <code class="ruby">            total_tip += livecomment.fetch(:tip)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="950">
            <span class="hits">4</span>
            

            

            <code class="ruby">            total_livecomments += 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="951">
            
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="952">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="953">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="954">
            
            

            

            <code class="ruby">        # 合計視聴者数</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="955">
            <span class="hits">2</span>
            

            

            <code class="ruby">        viewers_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="956">
            <span class="hits">2</span>
            

            

            <code class="ruby">        livestreams.each do |livestream|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="957">
            <span class="hits">18</span>
            

            

            <code class="ruby">          cnt = tx.xquery(&#39;SELECT COUNT(*) FROM livestream_viewers_history WHERE livestream_id = ?&#39;, livestream.fetch(:id), as: :array).first[0]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="958">
            <span class="hits">18</span>
            

            

            <code class="ruby">          viewers_count += cnt</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="959">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="960">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="961">
            
            

            

            <code class="ruby">        # お気に入り絵文字</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="962">
            <span class="hits">2</span>
            

            

            <code class="ruby">        favorite_emoji = tx.xquery(&lt;&lt;~SQL, username).first&amp;.fetch(:emoji_name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="963">
            
            

            

            <code class="ruby">          SELECT r.emoji_name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="964">
            
            

            

            <code class="ruby">          FROM users u</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="965">
            
            

            

            <code class="ruby">          INNER JOIN livestreams l ON l.user_id = u.id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="966">
            
            

            

            <code class="ruby">          INNER JOIN reactions r ON r.livestream_id = l.id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="967">
            
            

            

            <code class="ruby">          WHERE u.name = ?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="968">
            
            

            

            <code class="ruby">          GROUP BY emoji_name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="969">
            
            

            

            <code class="ruby">          ORDER BY COUNT(*) DESC, emoji_name DESC</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="970">
            
            

            

            <code class="ruby">          LIMIT 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="971">
            
            

            

            <code class="ruby">        SQL</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="972">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="973">
            
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="974">
            <span class="hits">2</span>
            

            

            <code class="ruby">          rank:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="975">
            
            

            

            <code class="ruby">          viewers_count:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="976">
            
            

            

            <code class="ruby">          total_reactions:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="977">
            
            

            

            <code class="ruby">          total_livecomments:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="978">
            
            

            

            <code class="ruby">          total_tip:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="979">
            
            

            

            <code class="ruby">          favorite_emoji:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="980">
            
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="981">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="982">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="983">
            <span class="hits">2</span>
            

            

            <code class="ruby">      json(stats)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="984">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="985">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="986">
            
            

            

            <code class="ruby">    LivestreamRankingEntry = Data.define(:livestream_id, :score)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="987">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="988">
            
            

            

            <code class="ruby">    # ライブ配信統計情報</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="989">
            
            

            

            <code class="ruby">    get &#39;/api/livestream/:livestream_id/statistics&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="990">
            <span class="hits">2</span>
            

            

            <code class="ruby">      verify_user_session!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="991">
            <span class="hits">2</span>
            

            

            <code class="ruby">      livestream_id = cast_as_integer(params[:livestream_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="992">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="993">
            <span class="hits">2</span>
            

            

            <code class="ruby">      stats = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="994">
            <span class="hits">2</span>
            

            

            <code class="ruby">        unless tx.xquery(&#39;SELECT * FROM livestreams WHERE id = ?&#39;, livestream_id).first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="995">
            
            

            

            <code class="ruby">          raise HttpError.new(400)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="996">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="997">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="998">
            
            

            

            <code class="ruby">        # ランク算出</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="999">
            <span class="hits">2</span>
            

            

            <code class="ruby">        ranking = tx.xquery(&#39;SELECT * FROM livestreams&#39;).map do |livestream|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14992" data-linenumber="1000">
            <span class="hits">14992</span>
            

            

            <code class="ruby">          reactions = tx.xquery(&#39;SELECT COUNT(*) FROM livestreams l INNER JOIN reactions r ON l.id = r.livestream_id WHERE l.id = ?&#39;, livestream.fetch(:id), as: :array).first[0]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1001">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14992" data-linenumber="1002">
            <span class="hits">14992</span>
            

            

            <code class="ruby">          total_tips = tx.xquery(&#39;SELECT IFNULL(SUM(l2.tip), 0) FROM livestreams l INNER JOIN livecomments l2 ON l.id = l2.livestream_id WHERE l.id = ?&#39;, livestream.fetch(:id), as: :array).first[0]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1003">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14992" data-linenumber="1004">
            <span class="hits">14992</span>
            

            

            <code class="ruby">          score = reactions + total_tips</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14992" data-linenumber="1005">
            <span class="hits">14992</span>
            

            

            <code class="ruby">          LivestreamRankingEntry.new(livestream_id: livestream.fetch(:id), score:)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1006">
            
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14994" data-linenumber="1007">
            <span class="hits">14994</span>
            

            

            <code class="ruby">        ranking.sort_by! { |entry| [entry.score, entry.livestream_id] }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="944" data-linenumber="1008">
            <span class="hits">944</span>
            

            

            <code class="ruby">        ridx = ranking.rindex { |entry| entry.livestream_id == livestream_id }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="1009">
            <span class="hits">2</span>
            

            

            <code class="ruby">        rank = ranking.size - ridx</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1010">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1011">
            
            

            

            <code class="ruby">	# 視聴者数算出</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="1012">
            <span class="hits">2</span>
            

            

            <code class="ruby">        viewers_count = tx.xquery(&#39;SELECT COUNT(*) FROM livestreams l INNER JOIN livestream_viewers_history h ON h.livestream_id = l.id WHERE l.id = ?&#39;, livestream_id, as: :array).first[0]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1013">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1014">
            
            

            

            <code class="ruby">	# 最大チップ額</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="1015">
            <span class="hits">2</span>
            

            

            <code class="ruby">        max_tip = tx.xquery(&#39;SELECT IFNULL(MAX(tip), 0) FROM livestreams l INNER JOIN livecomments l2 ON l2.livestream_id = l.id WHERE l.id = ?&#39;, livestream_id, as: :array).first[0]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1016">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1017">
            
            

            

            <code class="ruby">	# リアクション数</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="1018">
            <span class="hits">2</span>
            

            

            <code class="ruby">        total_reactions = tx.xquery(&#39;SELECT COUNT(*) FROM livestreams l INNER JOIN reactions r ON r.livestream_id = l.id WHERE l.id = ?&#39;, livestream_id, as: :array).first[0]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1019">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1020">
            
            

            

            <code class="ruby">	# スパム報告数</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="1021">
            <span class="hits">2</span>
            

            

            <code class="ruby">        total_reports = tx.xquery(&#39;SELECT COUNT(*) FROM livestreams l INNER JOIN livecomment_reports r ON r.livestream_id = l.id WHERE l.id = ?&#39;, livestream_id, as: :array).first[0]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1022">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1023">
            
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="1024">
            <span class="hits">2</span>
            

            

            <code class="ruby">          rank:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1025">
            
            

            

            <code class="ruby">          viewers_count:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1026">
            
            

            

            <code class="ruby">          max_tip:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1027">
            
            

            

            <code class="ruby">          total_reactions:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1028">
            
            

            

            <code class="ruby">          total_reports:,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1029">
            
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1030">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1031">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="1032">
            <span class="hits">2</span>
            

            

            <code class="ruby">      json(stats)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1033">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1034">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1035">
            
            

            

            <code class="ruby">    get &#39;/api/payment&#39; do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1036">
            <span class="hits">1</span>
            

            

            <code class="ruby">      total_tip = db_transaction do |tx|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1037">
            <span class="hits">1</span>
            

            

            <code class="ruby">        tx.xquery(&#39;SELECT IFNULL(SUM(tip), 0) FROM livecomments&#39;, as: :array).first[0]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1038">
            
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1039">
            
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1040">
            <span class="hits">1</span>
            

            

            <code class="ruby">      json(total_tip:)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1041">
            
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1042">
            
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1043">
            
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
